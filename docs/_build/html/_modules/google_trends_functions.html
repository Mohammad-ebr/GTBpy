

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>google_trends_functions &mdash; GTBpy Documentation 1.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=8d563738"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            GTBpy Documentation
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../modules.html">GTBpy</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">GTBpy Documentation</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Module code</a></li>
      <li class="breadcrumb-item active">google_trends_functions</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for google_trends_functions</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Functions are used to get hsi from Google trends data</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1">#%%</span>
<span class="c1"># Imports</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span>
<span class="kn">from</span> <span class="nn">statsmodels.tsa.stattools</span> <span class="kn">import</span> <span class="n">adfuller</span>
<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">ElasticNetCV</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span> <span class="nn">sklearn.decomposition</span> <span class="kn">import</span> <span class="n">PCA</span>
<span class="kn">from</span> <span class="nn">scipy.stats.mstats</span> <span class="kn">import</span> <span class="n">winsorize</span>

<span class="kn">from</span> <span class="nn">forecast_functions</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c1">#%%</span>

<div class="viewcode-block" id="trend_loader">
<a class="viewcode-back" href="../google_trends_functions.html#google_trends_functions.trend_loader">[docs]</a>
<span class="k">def</span> <span class="nf">trend_loader</span><span class="p">(</span><span class="n">hpi</span><span class="p">,</span> <span class="n">folder_path</span><span class="p">,</span> <span class="n">RE_companies</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">drop_companies</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">title_offset</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Loads google trends data in csv format in a folder and returns four dataframes</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    hpi : Pandas dataframe of shape (n_samples, 1)</span>
<span class="sd">          HPI index data</span>
<span class="sd">            </span>
<span class="sd">    folder_path : str</span>
<span class="sd">                  a folder path in which google trends data are stored.</span>
<span class="sd">                  </span>
<span class="sd">    RE_companies : list of strs, default = None</span>
<span class="sd">                    Name of real estate companies selected to constitute aggregate search of companies index.</span>
<span class="sd">                    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    df : pandas dataframe including HPI and all search queries</span>
<span class="sd">    df_full : pandas dataframe including HPI and search queries that have real value since 2004-01-01</span>
<span class="sd">    df_full_nonzero : pandas dataframe including HPI and search queries that have real value since 2004-01-01 and do not have values equal to zero</span>
<span class="sd">    df_part : pandas dataframe including HPI and search queries that are not in df_full</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">hpi</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">folder_path</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.csv&#39;</span><span class="p">):</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
            <span class="n">dft</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">date_format</span><span class="o">=</span><span class="s1">&#39;%Y-%m&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dft</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">):</span>
                <span class="n">dft</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">date_format</span><span class="o">=</span><span class="s1">&#39;%b-%y&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dft</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">):</span>
                <span class="n">dft</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">date_format</span><span class="o">=</span><span class="s1">&#39;%y-%b&#39;</span><span class="p">)</span>
            <span class="n">dft</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">dft</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="o">-</span><span class="n">title_offset</span><span class="p">]]</span>
            <span class="n">dft</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">dft</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_period</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_timestamp</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">)</span>
            <span class="n">dft</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dft</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&lt;1&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
            <span class="c1"># Exclude low search volume</span>
            <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">dft</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">dft</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">dft</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;coerce&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">asfreq</span><span class="p">(</span><span class="s1">&#39;ME&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">RE_companies</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;RE_companies&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">RE_companies</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">drop_companies</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">RE_companies</span><span class="p">)</span>
    
    <span class="n">df_full</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2004-01-01&#39;</span><span class="p">)])</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="n">df_part</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">df_full</span><span class="p">)]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="n">df_full_nonzero</span> <span class="o">=</span> <span class="n">df_full</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="o">~</span><span class="p">(</span><span class="n">df_full</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">df</span><span class="p">,</span> <span class="n">df_full</span><span class="p">,</span> <span class="n">df_full_nonzero</span><span class="p">,</span> <span class="n">df_part</span></div>


<span class="c1">#%%</span>

<div class="viewcode-block" id="reg_trend_selector">
<a class="viewcode-back" href="../google_trends_functions.html#google_trends_functions.reg_trend_selector">[docs]</a>
<span class="k">def</span> <span class="nf">reg_trend_selector</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">train_cut</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">recursive</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine the appropriate trend model for a time series based on the Augmented Dickey-Fuller (ADF) test.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    series : pd.Series</span>
<span class="sd">        The time series data to be analyzed.</span>
<span class="sd">    train_cut : str or pd.Timestamp</span>
<span class="sd">        The date or index that defines the end of the training period.</span>
<span class="sd">    alpha : float</span>
<span class="sd">        The significance level used to assess the p-value from the ADF test.</span>
<span class="sd">    recursive : bool</span>
<span class="sd">        If True, the function will recursively difference the series until stationarity is achieved, based on the ADF test.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    series : pd.Series</span>
<span class="sd">        The original or differenced time series, depending on the ADF test results.</span>
<span class="sd">    trend_cols : list of str</span>
<span class="sd">        A list of columns corresponding to the appropriate trend model, which may include:</span>
<span class="sd">        - &#39;const&#39; : Constant term</span>
<span class="sd">        - &#39;t&#39;     : Linear time trend</span>
<span class="sd">        - &#39;t2&#39;    : Quadratic time trend</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - The function performs the ADF test on the training period of the series with different trend models (&#39;c&#39;, &#39;ct&#39;, and &#39;ctt&#39;).</span>
<span class="sd">    - If the null hypothesis of the ADF test (that the series has a unit root) is not rejected at the given `alpha` level, the function recursively differences the series if `recursive` is set to True.</span>
<span class="sd">    - The trend model is chosen based on the significance of the ADF test with different trend components.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; series = pd.Series(np.random.randn(100).cumsum(), index=pd.date_range(&#39;2000-01-01&#39;, periods=100))</span>
<span class="sd">    &gt;&gt;&gt; series, trend_cols = reg_trend_selector(series, train_cut=&#39;2000-12-31&#39;, alpha=0.05, recursive=True)</span>
<span class="sd">        The function returns the appropriately differenced series and the trend model to be used.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">series</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="n">series_train</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">loc</span><span class="p">[:</span><span class="n">train_cut</span><span class="p">]</span>
    <span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">adfuller</span><span class="p">(</span><span class="n">series_train</span><span class="p">,</span> <span class="n">regression</span><span class="o">=</span><span class="s1">&#39;c&#39;</span><span class="p">)</span> <span class="c1"># tvalue(adf stat), pvalue, usedlag, nobs, critical values, icbest</span>
    <span class="k">if</span> <span class="n">p</span> <span class="o">&gt;</span> <span class="n">alpha</span><span class="p">:</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">adfuller</span><span class="p">(</span><span class="n">series_train</span><span class="p">,</span> <span class="n">regression</span><span class="o">=</span><span class="s1">&#39;ct&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">p</span> <span class="o">&gt;</span> <span class="n">alpha</span><span class="p">:</span>
            <span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">adfuller</span><span class="p">(</span><span class="n">series_train</span><span class="p">,</span> <span class="n">regression</span><span class="o">=</span><span class="s1">&#39;ctt&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">p</span> <span class="o">&gt;</span> <span class="n">alpha</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">recursive</span><span class="p">:</span>
                    <span class="n">series</span><span class="o">.</span><span class="n">loc</span><span class="p">[:],</span> <span class="n">trend_cols</span> <span class="o">=</span> <span class="n">reg_trend_selector</span><span class="p">(</span><span class="n">series</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">(),</span> <span class="n">train_cut</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">recursive</span><span class="p">)</span> <span class="c1"># we should use .loc[:] in order to maintain the series length and have NaN for indexes that are not in the assign values in the right hand side (values coming from reg_trend_selector(series.diff().dropna(), train_cut, alpha, recursive))</span>
                    <span class="n">order</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">series</span><span class="p">))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Taking the </span><span class="si">{</span><span class="p">(</span><span class="n">order</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="s2">&quot;first&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="o">==</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="s2">&quot;second&quot;</span><span class="si">}</span><span class="s1"> difference of </span><span class="si">{</span><span class="n">series</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The ADF test for </span><span class="si">{</span><span class="n">series</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> was not rejected in any of the cases &#39;c&#39;, &#39;ct&#39; and &#39;ctt&#39;.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">trend_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;const&#39;</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="s1">&#39;t2&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">trend_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;const&#39;</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">trend_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;const&#39;</span><span class="p">]</span>
                    
    <span class="k">return</span> <span class="n">series</span><span class="p">,</span> <span class="n">trend_cols</span></div>


<span class="c1">#%%</span>

<div class="viewcode-block" id="reg_detrend_deseasonal">
<a class="viewcode-back" href="../google_trends_functions.html#google_trends_functions.reg_detrend_deseasonal">[docs]</a>
<span class="k">def</span> <span class="nf">reg_detrend_deseasonal</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">train_cut</span><span class="p">,</span> <span class="n">deseasonal</span><span class="p">,</span> <span class="n">detrend</span><span class="p">,</span> <span class="n">regression</span><span class="o">=</span><span class="s1">&#39;ct&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Detrend and/or deseasonalize a DataFrame using linear regression.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pd.DataFrame</span>
<span class="sd">        The time series data to be detrended and/or deseasonalized. Each column is treated as a separate time series.</span>
<span class="sd">    train_cut : str, int, float, or pd.Timestamp</span>
<span class="sd">        The date or index that defines the end of the training period. If a float between 0 and 1 is provided, it represents a fraction of the total dataset length.</span>
<span class="sd">    deseasonal : bool</span>
<span class="sd">        If True, the function removes the seasonal component from the series using monthly dummies.</span>
<span class="sd">    detrend : bool</span>
<span class="sd">        If True, the function removes the trend component from the series based on the specified regression model.</span>
<span class="sd">    regression : {&#39;c&#39;, &#39;ct&#39;, &#39;ctt&#39;}, optional</span>
<span class="sd">        The type of trend model to be used:</span>
<span class="sd">        - &#39;c&#39; : Constant term only (default).</span>
<span class="sd">        - &#39;ct&#39; : Constant and linear trend.</span>
<span class="sd">        - &#39;ctt&#39; : Constant, linear, and quadratic trend.</span>
<span class="sd">        If None, the function automatically selects the trend model based on the Augmented Dickey-Fuller (ADF) test.</span>
<span class="sd">    alpha : float, optional</span>
<span class="sd">        The significance level used for the ADF test when automatically selecting the trend model. Default is 0.1.</span>
<span class="sd">    recursive : bool, optional</span>
<span class="sd">        If True, the function recursively differences the series until stationarity is achieved, based on the ADF test.</span>
<span class="sd">    col : list of str, optional</span>
<span class="sd">        A list of column names in `df` to be processed. If None, all columns are processed. Default is None.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pd.DataFrame</span>
<span class="sd">        A DataFrame with the detrended and/or deseasonalized series. The trend and seasonal components are removed according to the specified parameters.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - The function adds a constant (`const`), linear time trend (`t`), and quadratic time trend (`t2`) to the DataFrame as potential regressors.</span>
<span class="sd">    - Monthly dummy variables are generated and used to remove seasonality if `deseasonal` is True.</span>
<span class="sd">    - The function determines the appropriate trend model using the ADF test if `regression` is set to None.</span>
<span class="sd">    - The function drops the additional columns (`const`, `t`, `t2`, and seasonal dummies) before returning the final DataFrame.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; df = pd.DataFrame({&#39;HPI&#39;: np.random.randn(100).cumsum()}, index=pd.date_range(&#39;2000-01-01&#39;, periods=100))</span>
<span class="sd">    &gt;&gt;&gt; df_detrended = reg_detrend_deseasonal(df, train_cut=&#39;2005-01-01&#39;, deseasonal=True, detrend=True, regression=&#39;ct&#39;)</span>
<span class="sd">        This example removes both trend and seasonality from the &#39;HPI&#39; series in `df` using a linear trend model with a constant and linear trend.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">train_cut</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
        <span class="n">train_cut</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">*</span> <span class="n">train_cut</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">cols</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span>
    <span class="k">if</span> <span class="n">col</span><span class="p">:</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="n">col</span>
            
    <span class="n">time_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;const&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="p">:</span><span class="n">time_index</span><span class="p">,</span> <span class="s1">&#39;t2&#39;</span><span class="p">:</span><span class="n">time_index</span><span class="o">**</span><span class="mi">2</span><span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">month</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="n">dummies</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">month</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float&#39;</span><span class="p">,</span> <span class="n">drop_first</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">seasonal_cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dummies</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">dummies</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># This setup does not include &quot;const&quot; in deseasonalizing</span>
    <span class="n">base_deduct_cols</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">deseasonal</span><span class="p">:</span>
        <span class="n">base_deduct_cols</span> <span class="o">=</span> <span class="n">seasonal_cols</span>
        <span class="n">deduct_cols</span> <span class="o">=</span> <span class="n">seasonal_cols</span>
        
    <span class="k">if</span> <span class="n">regression</span> <span class="o">==</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span>
        <span class="n">trend_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;const&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">regression</span> <span class="o">==</span> <span class="s1">&#39;ct&#39;</span><span class="p">:</span>    
        <span class="n">trend_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;const&#39;</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">regression</span> <span class="o">==</span> <span class="s1">&#39;ctt&#39;</span><span class="p">:</span>
        <span class="n">trend_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;const&#39;</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="s1">&#39;t2&#39;</span><span class="p">]</span>
        
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">regression</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">trend_cols</span> <span class="o">=</span> <span class="n">reg_trend_selector</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">train_cut</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">recursive</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">detrend</span><span class="p">:</span>
            <span class="n">deduct_cols</span> <span class="o">=</span> <span class="n">base_deduct_cols</span> <span class="o">+</span> <span class="n">trend_cols</span>

        <span class="n">reg_cols</span> <span class="o">=</span> <span class="n">trend_cols</span> <span class="o">+</span> <span class="n">seasonal_cols</span>
        <span class="n">df_train</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:</span><span class="n">train_cut</span><span class="p">,</span> <span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">+</span> <span class="n">reg_cols</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">df_train</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">df_train</span><span class="p">[</span><span class="n">reg_cols</span><span class="p">])</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span><span class="o">.</span><span class="n">params</span>
        <span class="n">df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">-=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">deduct_cols</span><span class="p">]</span> <span class="o">@</span> <span class="n">params</span><span class="p">[</span><span class="n">deduct_cols</span><span class="p">])</span> <span class="c1"># df[c] -= sm.OLS(df[c], df[deduct_cols]).predict(params[deduct_cols])</span>
        <span class="c1"># from statsmodels.regression.linear_model import RegressionResults</span>
        <span class="c1"># df[c] = RegressionResults(sm.OLS(df[c], df[deduct_cols]), params[deduct_cols]).resid</span>
        
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;const&#39;</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="s1">&#39;t2&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">seasonal_cols</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">df</span></div>


<span class="c1">#%%</span>

<div class="viewcode-block" id="MA_detrend_deseasonal">
<a class="viewcode-back" href="../google_trends_functions.html#google_trends_functions.MA_detrend_deseasonal">[docs]</a>
<span class="k">def</span> <span class="nf">MA_detrend_deseasonal</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">train_cut</span><span class="p">,</span> <span class="n">deseasonal</span><span class="p">,</span> <span class="n">detrend</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Detrend and/or deseasonalize a DataFrame using moving average decomposition.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pd.DataFrame</span>
<span class="sd">        The time series data to be detrended and/or deseasonalized. Each column is treated as a separate time series.</span>
<span class="sd">    train_cut : str, int, float, or pd.Timestamp</span>
<span class="sd">        The date or index that defines the end of the training period. If a float between 0 and 1 is provided, it represents a fraction of the total dataset length.</span>
<span class="sd">    deseasonal : bool</span>
<span class="sd">        If True, the function removes the seasonal component from the series using moving average decomposition.</span>
<span class="sd">    detrend : bool</span>
<span class="sd">        If True, the function removes the trend component from the series using moving average decomposition.</span>
<span class="sd">    col : list of str, optional</span>
<span class="sd">        A list of column names in `df` to be processed. If None, all columns are processed. Default is None.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pd.DataFrame</span>
<span class="sd">        A DataFrame with the detrended and/or deseasonalized series. The trend and seasonal components are removed according to the specified parameters.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - The function uses `seasonal_decompose` from `statsmodels.tsa` to perform the moving average decomposition.</span>
<span class="sd">    - The `deseasonal` parameter removes the seasonal component using the seasonal decomposition from the training set.</span>
<span class="sd">    - The trend component is removed by subtracting the moving average trend calculated from the entire series.</span>
<span class="sd">    - The function creates a temporary column for month (`month`) to align seasonal adjustments, which is dropped before returning the final DataFrame.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; df = pd.DataFrame({&#39;HPI&#39;: np.random.randn(100).cumsum()}, index=pd.date_range(&#39;2000-01-01&#39;, periods=100))</span>
<span class="sd">    &gt;&gt;&gt; df_ma_detrended = MA_detrend_deseasonal(df, train_cut=&#39;2005-01-01&#39;, deseasonal=True, detrend=True)</span>
<span class="sd">        This example removes both trend and seasonality from the &#39;HPI&#39; series in `df` using moving average decomposition.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="n">cols</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span>
    <span class="k">if</span> <span class="n">col</span><span class="p">:</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="n">col</span>
        
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span>
    <span class="n">df_train</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:</span><span class="n">train_cut</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">detrend</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">-=</span> <span class="n">sm</span><span class="o">.</span><span class="n">tsa</span><span class="o">.</span><span class="n">seasonal_decompose</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">two_sided</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">trend</span>
        <span class="k">if</span> <span class="n">deseasonal</span><span class="p">:</span>
            <span class="n">seasonal</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">tsa</span><span class="o">.</span><span class="n">seasonal_decompose</span><span class="p">(</span><span class="n">df_train</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">model</span><span class="o">=</span><span class="s1">&#39;additive&#39;</span><span class="p">,</span> <span class="n">two_sided</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">seasonal</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">12</span><span class="p">]</span>
            <span class="n">seasonal</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">seasonal</span><span class="p">)</span>
            <span class="n">seasonal</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">seasonal</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="n">c</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">seasonal</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
            <span class="n">a</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">c</span><span class="p">]</span> <span class="o">-=</span> <span class="n">a</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;seasonal&#39;</span><span class="p">]</span>
            <span class="n">df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
        
            
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">])</span></div>

    
<span class="c1">#%%</span>

<div class="viewcode-block" id="prepare_gtrends">
<a class="viewcode-back" href="../google_trends_functions.html#google_trends_functions.prepare_gtrends">[docs]</a>
<span class="k">def</span> <span class="nf">prepare_gtrends</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">deseasonal</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;reg&#39;</span><span class="p">,</span> <span class="n">regression</span><span class="o">=</span><span class="s1">&#39;ct&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">smooth</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">winsorize_trends</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">train_cut</span><span class="o">=</span><span class="mf">0.8</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prepares Google Trends data by applying optional transformations such as detrending, deseasonalizing, smoothing, and logging.</span>
<span class="sd">    There are two ways when deterend=False and deseasonal=True. </span>
<span class="sd">    The first way is to just directly calculate the seasonal effect. </span>
<span class="sd">    The other way is that first calculate the trend, subtract it from series and then calculate the seasonal factors. Then subtract the seasonal factor from the original series.</span>
<span class="sd">    In this way we include trend and residuals in the series that we return as a result, and exclude seasonal factors.</span>
<span class="sd">    In this function,&#39;growth&#39; method uses the first way and &#39;MA&#39; and &#39;reg&#39; methods use the second.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pd.DataFrame</span>
<span class="sd">        A DataFrame where the first column is the dependent variable (e.g., HPI) and the remaining columns are Google Trends data.</span>
<span class="sd">    detrend : bool, optional</span>
<span class="sd">        If True, the function removes the trend component from the Google Trends data.</span>
<span class="sd">    deseasonal : bool, optional</span>
<span class="sd">        If True, the function removes the seasonal component from the Google Trends data.</span>
<span class="sd">    method : str, optional</span>
<span class="sd">        The method used for detrending and/or deseasonalizing. Options are &#39;reg&#39; for regression-based, &#39;MA&#39; for moving average, or &#39;growth&#39; for differencing. Default is &#39;reg&#39;.</span>
<span class="sd">    regression : str, optional</span>
<span class="sd">        The type of regression to use for detrending. Options are &#39;c&#39; (constant), &#39;ct&#39; (constant + trend), or &#39;ctt&#39; (constant + trend + quadratic trend). Used only if `method=&#39;reg&#39;`. Default is &#39;ct&#39;.</span>
<span class="sd">    alpha : float, optional</span>
<span class="sd">        The significance level for the augmented Dickey-Fuller test used in the regression-based method. Default is 0.15.</span>
<span class="sd">    log : bool, optional</span>
<span class="sd">        If True, log-transform the Google Trends data by applying `log(X + 1)` to avoid taking the logarithm of zero. Default is False.</span>
<span class="sd">    smooth : int or bool, optional</span>
<span class="sd">        The smoothing window size. If an integer is provided, it specifies the window size for the seasonal decomposition trend smoothing. If True, a default window size of 12 is used. Default is 12.</span>
<span class="sd">    winsorize_trends : bool, optional</span>
<span class="sd">        If True, winsorizes the Google Trends data by applying limits of 0.05 on both ends to reduce the impact of outliers. Default is False.</span>
<span class="sd">    train_cut : float or str or pd.Timestamp, optional</span>
<span class="sd">        The point at which to split the data into training and testing. If a float between 0 and 1 is provided, it represents a fraction of the total dataset length. If a string or timestamp is provided, it is used directly as a cutoff date. Default is 0.8.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pd.DataFrame</span>
<span class="sd">        A DataFrame with the dependent variable and the transformed Google Trends data. The exact transformations depend on the provided parameters.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    Exception</span>
<span class="sd">        If an invalid `method` is specified.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - The `method` parameter determines how the detrending and/or deseasonalizing is performed. &#39;reg&#39; uses regression-based methods, &#39;MA&#39; uses moving averages, and &#39;growth&#39; uses differencing.</span>
<span class="sd">    - The `smooth` parameter can be used to apply additional smoothing using seasonal decomposition.</span>
<span class="sd">    - The `log` transformation is applied after winsorizing if both are enabled.</span>
<span class="sd">    - The final DataFrame returned is merged on the index of the dependent variable and the transformed Google Trends data, ensuring alignment.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; df = pd.DataFrame({&#39;HPI&#39;: np.random.randn(100).cumsum(), &#39;trend&#39;: np.random.randn(100)}, index=pd.date_range(&#39;2000-01-01&#39;, periods=100))</span>
<span class="sd">    &gt;&gt;&gt; prepared_df = prepare_gtrends(df, detrend=True, deseasonal=True, method=&#39;MA&#39;, smooth=6)</span>
<span class="sd">        This example removes trend and seasonality using the moving average method and applies a smoothing window of 6 periods to the &#39;trend&#39; data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="n">winsorize_trends</span><span class="p">:</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">winsorize</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="p">[</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">X</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">train_cut</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
        <span class="n">train_cut</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">*</span> <span class="n">train_cut</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="n">detrend</span> <span class="o">|</span> <span class="n">deseasonal</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;MA&#39;</span><span class="p">:</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">MA_detrend_deseasonal</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">train_cut</span><span class="o">=</span><span class="n">train_cut</span><span class="p">,</span> <span class="n">deseasonal</span><span class="o">=</span><span class="n">deseasonal</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="n">detrend</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
                
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;reg&#39;</span><span class="p">:</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">reg_detrend_deseasonal</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">train_cut</span><span class="o">=</span><span class="n">train_cut</span><span class="p">,</span> <span class="n">deseasonal</span><span class="o">=</span><span class="n">deseasonal</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="n">detrend</span><span class="p">,</span> <span class="n">regression</span><span class="o">=</span><span class="n">regression</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
                
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;growth&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">detrend</span><span class="p">:</span>
                <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">deseasonal</span><span class="p">:</span>
                <span class="n">X</span> <span class="o">=</span> <span class="n">reg_detrend_deseasonal</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">train_cut</span><span class="o">=</span><span class="n">train_cut</span><span class="p">,</span> <span class="n">deseasonal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">regression</span><span class="o">=</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;&quot;method&quot; is not defined.&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">smooth</span><span class="p">:</span>
        <span class="n">smooth</span> <span class="o">=</span> <span class="mi">12</span> <span class="k">if</span> <span class="p">(</span><span class="n">smooth</span><span class="o">==</span><span class="kc">True</span><span class="p">)</span> <span class="k">else</span> <span class="n">smooth</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">X</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">tsa</span><span class="o">.</span><span class="n">seasonal_decompose</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">two_sided</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="n">smooth</span><span class="p">)</span><span class="o">.</span><span class="n">trend</span>
        <span class="c1"># X = X.rolling(window=smooth).mean()  # SMA</span>
        <span class="c1"># X = X.ewm(span=smooth).mean()  # EMA</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></div>



<span class="c1">#%%</span>

<div class="viewcode-block" id="prepare_hpi">
<a class="viewcode-back" href="../google_trends_functions.html#google_trends_functions.prepare_hpi">[docs]</a>
<span class="k">def</span> <span class="nf">prepare_hpi</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">deseasonal</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;reg&#39;</span><span class="p">,</span> <span class="n">regression</span><span class="o">=</span><span class="s1">&#39;ct&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">train_cut</span><span class="o">=</span><span class="mf">0.8</span><span class="p">):</span>
    <span class="c1"># ADF test stat is the tvalue of y_{t-1} in the regression, but the test pvalue is not the pvalue of coefficient of y_{t-1}.</span>
    <span class="c1"># This tvalue can change significantly with a small change of data since it uses large number of lags (12-15 lags in HPI case).</span>
    <span class="c1"># For example in regression=&#39;ct, for data range 2004-01 to 2019-12: t=-2.856 and p=0.177. For data range 2005-01 to 2019-12: t=-4.242 and p=0.0039 .</span>
    <span class="c1"># The start date of HPI can change based on whether we detrend gtrends by MA in the previous step.</span>
    <span class="c1"># That&#39;s why we can specify &#39;trend&#39; option to deternd data without needing to reject ADF test&#39;s null.</span>
    <span class="c1"># You can access regression results by following methods:</span>
        <span class="c1"># t, p, cv, result = adfuller(df_train[&#39;HPI&#39;], regression=&#39;ct&#39;, store=True, regresults=True)</span>
        <span class="c1"># result.autolag_results[lag].summary()</span>
        <span class="c1"># result.resols.summary()</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prepares the Housing Price Index (HPI) data by applying optional transformations such as detrending, deseasonalizing, and logging.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pd.DataFrame</span>
<span class="sd">        A DataFrame containing at least a column labeled &#39;HPI&#39;, representing the Housing Price Index.</span>
<span class="sd">    detrend : bool, optional</span>
<span class="sd">        If True, removes the trend component from the HPI data. Default is False.</span>
<span class="sd">    deseasonal : bool, optional</span>
<span class="sd">        If True, removes the seasonal component from the HPI data. Default is False.</span>
<span class="sd">    method : str, optional</span>
<span class="sd">        The method used for detrending and/or deseasonalizing. Options are &#39;reg&#39; for regression-based or &#39;MA&#39; for moving average. Default is &#39;reg&#39;.</span>
<span class="sd">    regression : str, optional</span>
<span class="sd">        The type of regression to use for detrending. Options are &#39;c&#39; (constant), &#39;ct&#39; (constant + trend), or &#39;ctt&#39; (constant + trend + quadratic trend). Used only if `method=&#39;reg&#39;`. Default is &#39;ct&#39;.</span>
<span class="sd">    alpha : float, optional</span>
<span class="sd">        The significance level for the augmented Dickey-Fuller (ADF) test used in the regression-based method. Default is 0.15.</span>
<span class="sd">    log : bool, optional</span>
<span class="sd">        If True, log-transforms the HPI data by applying `log(HPI)`. Default is False.</span>
<span class="sd">    train_cut : float or str or pd.Timestamp, optional</span>
<span class="sd">        The point at which to split the data into training and testing. If a float between 0 and 1 is provided, it represents a fraction of the total dataset length. If a string or timestamp is provided, it is used directly as a cutoff date. Default is 0.8.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pd.DataFrame</span>
<span class="sd">        A DataFrame with the transformed HPI data, depending on the selected options for detrending, deseasonalizing, and logging.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    Exception</span>
<span class="sd">        If an attempt is made to detrend HPI using the Moving Average method.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - The function includes a log transformation option to stabilize variance, which is applied before any other transformations.</span>
<span class="sd">    - Detrending using the Moving Average (MA) method is explicitly disallowed for the HPI, as indicated by an exception.</span>
<span class="sd">    - The ADF test&#39;s significance level (`alpha`) and type of regression used can significantly impact the detrending process, particularly in borderline cases.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; df = pd.DataFrame({&#39;HPI&#39;: np.random.randn(100).cumsum()}, index=pd.date_range(&#39;2000-01-01&#39;, periods=100))</span>
<span class="sd">    &gt;&gt;&gt; prepared_df = prepare_hpi(df, detrend=True, deseasonal=True, method=&#39;reg&#39;, regression=&#39;ct&#39;)</span>
<span class="sd">        This example removes the trend and seasonality from the HPI data using a regression-based method with a constant and trend.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;HPI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;HPI&#39;</span><span class="p">])</span>
        
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">train_cut</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
        <span class="n">train_cut</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">*</span> <span class="n">train_cut</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">detrend</span> <span class="o">|</span> <span class="n">deseasonal</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;reg&#39;</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;HPI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg_detrend_deseasonal</span><span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="s1">&#39;HPI&#39;</span><span class="p">]],</span> <span class="n">train_cut</span><span class="o">=</span><span class="n">train_cut</span><span class="p">,</span> <span class="n">deseasonal</span><span class="o">=</span><span class="n">deseasonal</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="n">detrend</span><span class="p">,</span> <span class="n">regression</span><span class="o">=</span><span class="n">regression</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="kc">None</span><span class="p">)[</span><span class="s1">&#39;HPI&#39;</span><span class="p">]</span>
        
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;MA&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">detrend</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;We are not allowed to detrend HPI by Moving Average method!!&#39;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">deseasonal</span><span class="p">:</span>
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;HPI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MA_detrend_deseasonal</span><span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="s1">&#39;HPI&#39;</span><span class="p">]],</span> <span class="n">train_cut</span><span class="o">=</span><span class="n">train_cut</span><span class="p">,</span> <span class="n">deseasonal</span><span class="o">=</span><span class="n">deseasonal</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="kc">None</span><span class="p">)[</span><span class="s1">&#39;HPI&#39;</span><span class="p">]</span>
                
    <span class="k">return</span> <span class="n">df</span></div>


<span class="c1">#%%</span>

<div class="viewcode-block" id="compute_weights">
<a class="viewcode-back" href="../google_trends_functions.html#google_trends_functions.compute_weights">[docs]</a>
<span class="k">def</span> <span class="nf">compute_weights</span><span class="p">(</span><span class="n">criteria</span><span class="p">,</span> <span class="n">var_select</span><span class="p">,</span> <span class="n">selection_index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">coef_select</span><span class="o">=</span><span class="s1">&#39;abs&#39;</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">power</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">rank_based</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes weights for a set of criteria, selecting top variables or indices based on the specified selection method.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    criteria : pd.Series or pd.DataFrame</span>
<span class="sd">        The data containing the criteria used to compute weights, such as coefficients or cross-validation errors.</span>
<span class="sd">    var_select : str</span>
<span class="sd">        The selection method for the variables. Options include &#39;EN&#39; (Elastic Net), &#39;coef&#39; (coefficient), &#39;tvalue&#39;, &#39;CV&#39; (cross-validation), or &#39;IC&#39; (information criterion).</span>
<span class="sd">    selection_index : pd.Index or list, optional</span>
<span class="sd">        The indices to consider for selection. If None, the entire index of `criteria` is used. Default is None.</span>
<span class="sd">    coef_select : str, optional</span>
<span class="sd">        Method for selecting coefficients. Options are &#39;abs&#39; for absolute values or &#39;neg&#39; for negative values. Only relevant if `var_select` is &#39;EN&#39;, &#39;coef&#39;, or &#39;tvalue&#39;. Default is &#39;abs&#39;.</span>
<span class="sd">    n : int, optional</span>
<span class="sd">        The number of top variables or indices to select based on the computed weights. Default is 10.</span>
<span class="sd">    power : int or float, optional</span>
<span class="sd">        The exponent used to compute the weights. Higher powers give more weight to larger values (or smaller values if using `var_select=&#39;CV&#39;` or `var_select=&#39;IC&#39;`). Default is 4.</span>
<span class="sd">    rank_based : bool, optional</span>
<span class="sd">        If True, weights are computed based on the rank of each criterion rather than its raw value. Default is False.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    weights : pd.Series</span>
<span class="sd">        A series of computed weights corresponding to the criteria.</span>
<span class="sd">    top_queries : pd.Index or list</span>
<span class="sd">        The top `n` indices or variables based on the computed weights.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If an invalid value for `var_select` or `coef_select` is provided.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - The function supports both positive and negative selection of coefficients, depending on the `coef_select` parameter.</span>
<span class="sd">    - When `rank_based` is True, the function ranks the criteria before computing the weights, which can be useful for stabilizing the selection process.</span>
<span class="sd">    - The function supports two main types of selection: those based on coefficient magnitudes (&#39;EN&#39;, &#39;coef&#39;, &#39;tvalue&#39;) and those based on error metrics (&#39;CV&#39;, &#39;IC&#39;).</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; criteria = pd.Series([0.2, -0.5, 1.0, -0.3, 0.7], index=[&#39;A&#39;, &#39;B&#39;, &#39;C&#39;, &#39;D&#39;, &#39;E&#39;])</span>
<span class="sd">    &gt;&gt;&gt; weights, top_queries = compute_weights(criteria, var_select=&#39;coef&#39;, coef_select=&#39;abs&#39;, n=3)</span>
<span class="sd">    &gt;&gt;&gt; print(weights)</span>
<span class="sd">    A    0.061926</span>
<span class="sd">    B    0.142322</span>
<span class="sd">    C    0.388067</span>
<span class="sd">    D    0.100637</span>
<span class="sd">    E    0.307048</span>
<span class="sd">    dtype: float64</span>
<span class="sd">    &gt;&gt;&gt; print(top_queries)</span>
<span class="sd">    Index([&#39;C&#39;, &#39;E&#39;, &#39;B&#39;], dtype=&#39;object&#39;)</span>

<span class="sd">    &gt;&gt;&gt; criteria = pd.Series([0.8, 0.5, 1.2, 0.9, 0.6], index=[&#39;A&#39;, &#39;B&#39;, &#39;C&#39;, &#39;D&#39;, &#39;E&#39;])</span>
<span class="sd">    &gt;&gt;&gt; weights, top_queries = compute_weights(criteria, var_select=&#39;CV&#39;, rank_based=True, n=2)</span>
<span class="sd">    &gt;&gt;&gt; print(weights)</span>
<span class="sd">    A    0.214796</span>
<span class="sd">    B    0.355939</span>
<span class="sd">    C    0.131228</span>
<span class="sd">    D    0.178110</span>
<span class="sd">    E    0.119927</span>
<span class="sd">    dtype: float64</span>
<span class="sd">    &gt;&gt;&gt; print(top_queries)</span>
<span class="sd">    Index([&#39;B&#39;, &#39;D&#39;], dtype=&#39;object&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">selection_index</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">selection_index</span> <span class="o">=</span> <span class="n">criteria</span><span class="o">.</span><span class="n">index</span>
        
    <span class="k">if</span> <span class="n">var_select</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;EN&#39;</span><span class="p">,</span> <span class="s1">&#39;coef&#39;</span><span class="p">,</span> <span class="s1">&#39;tvalue&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">coef_select</span> <span class="o">==</span> <span class="s1">&#39;abs&#39;</span><span class="p">:</span>
            <span class="n">criteria</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">criteria</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">coef_select</span> <span class="o">==</span> <span class="s1">&#39;neg&#39;</span><span class="p">:</span>
            <span class="n">criteria</span> <span class="o">=</span> <span class="o">-</span><span class="n">criteria</span>
        
        <span class="k">if</span> <span class="n">rank_based</span><span class="p">:</span>
            <span class="n">ranks</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">criteria</span><span class="p">)</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">ranks</span><span class="p">)</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span> <span class="o">/</span> <span class="n">weights</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">criteria</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">criteria</span> <span class="o">-=</span> <span class="nb">min</span><span class="p">(</span><span class="n">criteria</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.1</span> <span class="c1"># criteria += abs(min(criteria)) + abs(max(criteria)) # criteria += abs(min(criteria)) + 1</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="p">(</span><span class="n">criteria</span> <span class="o">**</span> <span class="n">power</span><span class="p">)</span><span class="o">/</span><span class="nb">sum</span><span class="p">(</span><span class="n">criteria</span> <span class="o">**</span> <span class="n">power</span><span class="p">)</span>
        
        <span class="n">top_queries</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">criteria</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">selection_index</span><span class="p">])</span><span class="o">.</span><span class="n">sort_values</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span>
        
    <span class="k">elif</span> <span class="n">var_select</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;CV&#39;</span><span class="p">,</span> <span class="s1">&#39;IC&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">rank_based</span><span class="p">:</span>
            <span class="n">ranks</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">criteria</span><span class="p">)</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">ranks</span><span class="p">)</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span> <span class="o">/</span> <span class="n">weights</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">criteria</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">criteria</span> <span class="o">-=</span> <span class="nb">min</span><span class="p">(</span><span class="n">criteria</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.1</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">criteria</span> <span class="o">**</span> <span class="n">power</span><span class="p">))</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">criteria</span> <span class="o">**</span> <span class="n">power</span><span class="p">))</span>
        
        <span class="n">top_queries</span> <span class="o">=</span> <span class="n">criteria</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">selection_index</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span>
        
    <span class="k">return</span> <span class="n">weights</span><span class="p">,</span> <span class="n">top_queries</span></div>



<span class="c1">#%%</span>

<span class="k">def</span> <span class="nf">select_lag</span><span class="p">(</span><span class="n">criterias</span><span class="p">,</span> <span class="n">var_select</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">var_select</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;EN&#39;</span><span class="p">,</span> <span class="s1">&#39;coef&#39;</span><span class="p">,</span> <span class="s1">&#39;tvalue&#39;</span><span class="p">]:</span>
        <span class="n">criteria</span> <span class="o">=</span> <span class="n">criterias</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.L&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">criteria</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.L&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">var_select</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;CV&#39;</span><span class="p">,</span> <span class="s1">&#39;IC&#39;</span><span class="p">]:</span>
        <span class="n">criteria</span> <span class="o">=</span> <span class="n">criterias</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.L&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">criterias</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.L&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">criteria</span><span class="p">,</span> <span class="n">index</span>

<span class="c1">#%%</span>

<span class="k">def</span> <span class="nf">scale_lag_X</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">train_cut</span><span class="p">,</span> <span class="n">lagged</span><span class="p">,</span> <span class="n">max_lag</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="n">X_train</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">loc</span><span class="p">[:</span><span class="n">train_cut</span><span class="p">]</span>

    <span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
    <span class="n">X_scaled</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">scaler</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">lagged</span><span class="p">:</span>
        <span class="n">X_scaled_lagged</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">X_scaled</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">lag</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_lag</span><span class="p">):</span>
                <span class="n">X_scaled_lagged</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">feature</span><span class="si">}</span><span class="s1">.L</span><span class="si">{</span><span class="n">lag</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">X_scaled</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">lag</span><span class="p">)</span>
        <span class="n">X_scaled</span> <span class="o">=</span> <span class="n">X_scaled_lagged</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        
    <span class="n">X_train_scaled</span> <span class="o">=</span> <span class="n">X_scaled</span><span class="o">.</span><span class="n">loc</span><span class="p">[:</span><span class="n">train_cut</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="n">X_scaled</span><span class="p">,</span> <span class="n">X_train_scaled</span>

<span class="c1">#%%</span>

<span class="k">def</span> <span class="nf">reduce_criteria_expanded</span><span class="p">(</span><span class="n">criteria_dfs_expanded</span><span class="p">,</span> <span class="n">var_select</span><span class="p">,</span> <span class="n">lags</span><span class="p">,</span> <span class="n">coef_select</span><span class="p">):</span>
    
    <span class="n">only_criteria_df_full</span> <span class="o">=</span> <span class="n">criteria_dfs_expanded</span><span class="p">[[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">criteria_dfs_expanded</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">var_select</span><span class="p">)]]</span>
    
    <span class="k">if</span> <span class="n">var_select</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;EN&#39;</span><span class="p">,</span> <span class="s1">&#39;coef&#39;</span><span class="p">,</span> <span class="s1">&#39;tvalue&#39;</span><span class="p">]:</span>
        <span class="n">only_criteria_df</span> <span class="o">=</span> <span class="n">only_criteria_df_full</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[:</span><span class="mi">2</span><span class="p">]))</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
        <span class="n">min_col_df</span> <span class="o">=</span> <span class="n">only_criteria_df_full</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[:</span><span class="mi">2</span><span class="p">]))</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
    <span class="k">elif</span> <span class="n">var_select</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;CV&#39;</span><span class="p">,</span> <span class="s1">&#39;IC&#39;</span><span class="p">]:</span>
        <span class="n">only_criteria_df</span> <span class="o">=</span> <span class="n">only_criteria_df_full</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[:</span><span class="mi">2</span><span class="p">]))</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
        <span class="n">min_col_df</span> <span class="o">=</span> <span class="n">only_criteria_df_full</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[:</span><span class="mi">2</span><span class="p">]))</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
    <span class="n">min_col_df</span> <span class="o">=</span> <span class="n">min_col_df</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">var_select</span><span class="p">,</span> <span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="n">index_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">only_criteria_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">var_select</span><span class="p">,</span> <span class="s1">&#39;index&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">only_criteria_df</span><span class="o">.</span><span class="n">columns</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">criteria_dfs_expanded</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
        <span class="n">index_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">criteria_dfs_expanded</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">min_col_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">criteria_dfs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">only_criteria_df</span><span class="p">,</span> <span class="n">index_df</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># criteria_dfs = criteria_dfs[[col for pair in zip(only_criteria_df.columns, index_df.columns) for col in pair]]</span>
    
    <span class="k">for</span> <span class="n">lag</span> <span class="ow">in</span> <span class="n">lags</span><span class="p">:</span>
        <span class="n">weights</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">compute_weights</span><span class="p">(</span><span class="n">criteria</span><span class="o">=</span><span class="n">criteria_dfs</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">var_select</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">lag</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">],</span> <span class="n">var_select</span><span class="o">=</span><span class="n">var_select</span><span class="p">,</span> <span class="n">coef_select</span><span class="o">=</span><span class="n">coef_select</span><span class="p">,</span> <span class="n">power</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">rank_based</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">criteria_dfs</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="sa">f</span><span class="s1">&#39;weight_</span><span class="si">{</span><span class="n">lag</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">weights</span>
        
    <span class="n">criteria_dfs</span> <span class="o">=</span> <span class="n">criteria_dfs</span><span class="p">[[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">lag</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">lag</span> <span class="ow">in</span> <span class="n">lags</span> <span class="k">for</span> <span class="n">title</span> <span class="ow">in</span> <span class="p">[</span><span class="n">var_select</span><span class="p">,</span> <span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">]]]</span>
    
    <span class="k">return</span> <span class="n">criteria_dfs</span>

<span class="c1">#%%</span>

<span class="k">def</span> <span class="nf">pca_hsi_dif_lags</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">hsi_dfs</span><span class="p">,</span> <span class="n">X_scaled_lagged_full</span><span class="p">,</span> <span class="n">criteria_dfs</span><span class="p">,</span> <span class="n">old_best</span><span class="p">,</span> <span class="n">input_pool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">auto_layer</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_lag</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">var_select</span><span class="o">=</span><span class="s1">&#39;EN&#39;</span><span class="p">,</span> <span class="n">random</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">n_iter</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">n_hsi</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">train_cut</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">alphas</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">100</span><span class="p">),</span> <span class="n">l1_ratio</span><span class="o">=</span><span class="p">[</span><span class="mf">.1</span><span class="p">,</span> <span class="mf">.5</span><span class="p">,</span> <span class="mf">.7</span><span class="p">,</span> <span class="mf">.9</span><span class="p">,</span> <span class="mf">.95</span><span class="p">,</span> <span class="mf">.99</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">lags</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">12</span><span class="p">],</span> <span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">coef_select</span><span class="o">=</span><span class="s1">&#39;abs&#39;</span><span class="p">,</span> <span class="n">criteria_dis</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">train_cut</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
        <span class="n">train_cut</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">*</span> <span class="n">train_cut</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        
    <span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">max_lag</span><span class="o">-</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">y_train</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">loc</span><span class="p">[:</span><span class="n">train_cut</span><span class="p">]</span>

    <span class="n">X</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span>
    <span class="n">X_scaled_lagged</span><span class="p">,</span> <span class="n">X_train_scaled_lagged</span> <span class="o">=</span> <span class="n">scale_lag_X</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">train_cut</span><span class="o">=</span><span class="n">train_cut</span><span class="p">,</span> <span class="n">lagged</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">max_lag</span><span class="o">=</span><span class="n">max_lag</span><span class="p">)</span>
    <span class="n">X_scaled_lagged_full</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">X_scaled_lagged_full</span><span class="p">,</span> <span class="n">X_scaled_lagged</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="n">X_train_scaled_lagged_full</span> <span class="o">=</span> <span class="n">X_scaled_lagged_full</span><span class="o">.</span><span class="n">loc</span><span class="p">[:</span><span class="n">train_cut</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">var_select</span> <span class="o">==</span> <span class="s1">&#39;EN&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">input_pool</span><span class="p">:</span>
        <span class="n">X_scaled_lagged</span><span class="p">,</span> <span class="n">X_train_scaled_lagged</span> <span class="o">=</span> <span class="n">X_scaled_lagged_full</span><span class="p">,</span> <span class="n">X_train_scaled_lagged_full</span>
    
    <span class="k">if</span> <span class="n">input_pool</span><span class="p">:</span>
        <span class="n">selection_index</span> <span class="o">=</span> <span class="n">hsi_dfs</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">selection_index</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

    <span class="n">hsi</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">max_lag</span><span class="o">-</span><span class="mi">1</span><span class="p">:])</span>
    <span class="n">criteria_dfs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">criteria_dfs</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:])])</span>
    <span class="n">criteria_df_lagged</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">X_scaled_lagged</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="n">trends_count_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    
    <span class="k">for</span> <span class="n">lag</span> <span class="ow">in</span> <span class="n">lags</span><span class="p">:</span>
        <span class="n">trends_count</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">y_adj</span> <span class="o">=</span> <span class="n">y_train</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">lag</span><span class="p">:]</span>
        <span class="n">X_adj</span> <span class="o">=</span> <span class="n">X_train_scaled_lagged</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">lag</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        
        <span class="n">criteria_lagged</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        
        <span class="k">if</span> <span class="n">var_select</span> <span class="o">==</span> <span class="s1">&#39;EN&#39;</span><span class="p">:</span>
            <span class="n">elastic_net_cv</span> <span class="o">=</span> <span class="n">ElasticNetCV</span><span class="p">(</span><span class="n">fit_intercept</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alphas</span><span class="o">=</span><span class="n">alphas</span><span class="p">,</span> <span class="n">l1_ratio</span><span class="o">=</span><span class="n">l1_ratio</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">20000</span><span class="p">)</span>
            <span class="n">elastic_net_cv</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_adj</span><span class="p">,</span> <span class="n">y_adj</span><span class="p">)</span> <span class="c1"># I don&#39;t know if it is better to include all exogs in the ElasticNet or just the exog of the last layer</span>
            <span class="n">criteria_lagged</span> <span class="o">=</span> <span class="n">elastic_net_cv</span><span class="o">.</span><span class="n">coef_</span>

        <span class="k">elif</span> <span class="n">var_select</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;coef&#39;</span><span class="p">,</span> <span class="s1">&#39;tvalue&#39;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">X_adj</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">model</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">y_adj</span><span class="p">,</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">X_adj</span><span class="p">[[</span><span class="n">feature</span><span class="p">]]))</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">var_select</span> <span class="o">==</span> <span class="s1">&#39;coef&#39;</span><span class="p">:</span>
                    <span class="n">criteria_lagged</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">criteria_lagged</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">var_select</span> <span class="o">==</span> <span class="s1">&#39;tvalue&#39;</span><span class="p">:</span>
                    <span class="n">criteria_lagged</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">criteria_lagged</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">tvalues</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        
        <span class="k">elif</span> <span class="n">var_select</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;CV&#39;</span><span class="p">,</span> <span class="s1">&#39;IC&#39;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">X_adj</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">ic</span> <span class="o">=</span> <span class="n">compute_ic_cv</span><span class="p">(</span><span class="n">y_adj</span><span class="p">,</span> <span class="n">X_adj</span><span class="p">[[</span><span class="n">feature</span><span class="p">]],</span> <span class="n">metric</span><span class="o">=</span><span class="n">var_select</span><span class="p">,</span> <span class="n">fit_intercept</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="n">cv</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="n">shuffle</span><span class="p">,</span> <span class="n">n_iter</span><span class="o">=</span><span class="n">n_iter</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
                <span class="n">criteria_lagged</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">criteria_lagged</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
            
        <span class="n">criteria_df_lagged</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">X_adj</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">var_select</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">lag</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">criteria_lagged</span>
        <span class="n">criteria</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">select_lag</span><span class="p">(</span><span class="n">criteria_df_lagged</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">var_select</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">lag</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">],</span> <span class="n">var_select</span><span class="o">=</span><span class="n">var_select</span><span class="p">)</span>
        <span class="n">criteria_dfs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">var_select</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">lag</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">criteria</span>
        <span class="n">criteria_dfs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;index_</span><span class="si">{</span><span class="n">lag</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">index</span>
        
        <span class="n">weights_full</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">compute_weights</span><span class="p">(</span><span class="n">criteria</span><span class="o">=</span><span class="n">criteria_dfs</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">var_select</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">lag</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">],</span> <span class="n">var_select</span><span class="o">=</span><span class="n">var_select</span><span class="p">,</span> <span class="n">coef_select</span><span class="o">=</span><span class="n">coef_select</span><span class="p">,</span> <span class="n">power</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">rank_based</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">criteria_dfs</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;weight_</span><span class="si">{</span><span class="n">lag</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">weights_full</span>
        
        <span class="n">top_queries</span> <span class="o">=</span> <span class="n">criteria_dfs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">selection_index</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;weight_</span><span class="si">{</span><span class="n">lag</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="sa">f</span><span class="s1">&#39;index_</span><span class="si">{</span><span class="n">lag</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">random</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_hsi</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">selection_weights</span> <span class="o">=</span> <span class="n">criteria_dfs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">selection_index</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;weight_</span><span class="si">{</span><span class="n">lag</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">criteria_dfs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">selection_index</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;weight_</span><span class="si">{</span><span class="n">lag</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="n">top_queries</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">criteria_dfs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">selection_index</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;index_</span><span class="si">{</span><span class="n">lag</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">selection_weights</span><span class="p">)</span>
                    
                <span class="c1"># Select the n queries with the highest coefficients by their absolute(?) values   </span>
                <span class="n">X_scaled_selected</span> <span class="o">=</span> <span class="n">X_scaled_lagged_full</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">top_queries</span><span class="p">]</span>
                <span class="n">X_train_scaled_selected</span> <span class="o">=</span> <span class="n">X_train_scaled_lagged_full</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">top_queries</span><span class="p">]</span>
                <span class="n">trends_count</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">X_scaled_selected</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">var_select</span> <span class="o">==</span> <span class="s1">&#39;EN&#39;</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;hsi_</span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">lag</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s1">,  alpha:</span><span class="si">{</span><span class="n">elastic_net_cv</span><span class="o">.</span><span class="n">alpha_</span><span class="si">}</span><span class="s1">,  l1_ratio: </span><span class="si">{</span><span class="n">elastic_net_cv</span><span class="o">.</span><span class="n">l1_ratio_</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s1"> Selected queries for hsi_</span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">lag</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s1">:</span><span class="se">\n</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X_scaled_selected</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

                <span class="c1"># Apply PCA</span>
                <span class="n">pca</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">principal_component</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled_selected</span><span class="p">)</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_scaled_selected</span><span class="p">)</span>
                <span class="n">hsi</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;hsi_</span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">lag</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">principal_component</span>
            
            <span class="n">values</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">trends_count</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="sa">f</span><span class="s1">&#39;count_</span><span class="si">{</span><span class="n">lag</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">:</span><span class="n">counts</span><span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="n">values</span><span class="p">)</span>
            <span class="n">trends_count_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">trends_count_df</span><span class="p">,</span> <span class="n">a</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">trends_count_df</span> <span class="o">=</span> <span class="n">trends_count_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">trends_count_df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Select the n queries with the highest coefficients by their absolute(?) values</span>
            <span class="n">X_scaled_selected</span> <span class="o">=</span> <span class="n">X_scaled_lagged_full</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">top_queries</span><span class="p">]</span>
            <span class="n">X_train_scaled_selected</span> <span class="o">=</span> <span class="n">X_train_scaled_lagged_full</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">top_queries</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">var_select</span> <span class="o">==</span> <span class="s1">&#39;EN&#39;</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;hsi_</span><span class="si">{</span><span class="n">lag</span><span class="si">}</span><span class="s1">,  alpha:</span><span class="si">{</span><span class="n">elastic_net_cv</span><span class="o">.</span><span class="n">alpha_</span><span class="si">}</span><span class="s1">,  l1_ratio:</span><span class="si">{</span><span class="n">elastic_net_cv</span><span class="o">.</span><span class="n">l1_ratio_</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s1"> Selected queries for hsi_</span><span class="si">{</span><span class="n">lag</span><span class="si">}</span><span class="s1">:</span><span class="se">\n</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X_scaled_selected</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="c1"># Apply PCA</span>
            <span class="n">pca</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">principal_component</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled_selected</span><span class="p">)</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_scaled_selected</span><span class="p">)</span>
            <span class="n">hsi</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;hsi_</span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">lag</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">principal_component</span>
            
        
    <span class="k">if</span> <span class="p">(</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">bool</span><span class="p">(</span><span class="n">random</span><span class="p">):</span>
        <span class="n">display</span><span class="p">(</span><span class="n">trends_count_df</span><span class="p">)</span>
    
    <span class="n">criteria_dfs</span> <span class="o">=</span> <span class="n">criteria_dfs</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;weight_</span><span class="si">{</span><span class="nb">max</span><span class="p">(</span><span class="n">lags</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">abs</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">criteria_dis</span><span class="p">:</span>
        <span class="n">display</span><span class="p">(</span><span class="n">criteria_dfs</span><span class="p">)</span>
    
    <span class="c1"># `principal_component` now contains the first principal component of the selected search queries</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">hsi</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">var_select</span> <span class="o">==</span> <span class="s1">&#39;EN&#39;</span><span class="p">:</span>
        <span class="n">hsi_dfs</span> <span class="o">=</span> <span class="n">df</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">hsi_dfs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">hsi_dfs</span><span class="p">,</span> <span class="n">hsi</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">join</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">auto_layer</span><span class="p">:</span>
        <span class="n">new_best</span> <span class="o">=</span> <span class="n">criteria_dfs</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">var_select</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="nb">max</span><span class="p">(</span><span class="n">lags</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">layer</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">new_best</span> <span class="o">!=</span> <span class="n">old_best</span><span class="p">:</span>
            <span class="n">df</span><span class="p">,</span> <span class="n">hsi_dfs</span><span class="p">,</span> <span class="n">X_scaled_lagged_full</span><span class="p">,</span> <span class="n">criteria_dfs</span> <span class="o">=</span> <span class="n">pca_hsi_dif_lags</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">hsi_dfs</span><span class="p">,</span> <span class="n">X_scaled_lagged_full</span><span class="p">,</span> <span class="n">criteria_dfs</span><span class="p">,</span> <span class="n">new_best</span><span class="p">,</span> <span class="n">input_pool</span><span class="o">=</span><span class="n">input_pool</span><span class="p">,</span> <span class="n">auto_layer</span><span class="o">=</span><span class="n">auto_layer</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="n">layer</span><span class="p">,</span> <span class="n">max_lag</span><span class="o">=</span><span class="n">max_lag</span><span class="p">,</span> <span class="n">var_select</span><span class="o">=</span><span class="n">var_select</span><span class="p">,</span> <span class="n">random</span><span class="o">=</span><span class="n">random</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="n">cv</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="n">shuffle</span><span class="p">,</span> <span class="n">n_iter</span><span class="o">=</span><span class="n">n_iter</span><span class="p">,</span> <span class="n">n_hsi</span><span class="o">=</span><span class="n">n_hsi</span><span class="p">,</span> <span class="n">train_cut</span><span class="o">=</span><span class="n">train_cut</span><span class="p">,</span> <span class="n">alphas</span><span class="o">=</span><span class="n">alphas</span><span class="p">,</span> <span class="n">l1_ratio</span><span class="o">=</span><span class="n">l1_ratio</span><span class="p">,</span> <span class="n">lags</span><span class="o">=</span><span class="n">lags</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">coef_select</span><span class="o">=</span><span class="n">coef_select</span><span class="p">,</span> <span class="n">criteria_dis</span><span class="o">=</span><span class="n">criteria_dis</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span> 
    
    <span class="k">return</span> <span class="n">df</span><span class="p">,</span> <span class="n">hsi_dfs</span><span class="p">,</span> <span class="n">X_scaled_lagged_full</span><span class="p">,</span> <span class="n">criteria_dfs</span>

<span class="c1">#%%</span>

<span class="k">def</span> <span class="nf">pca_hsi</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">hsi_dfs</span><span class="p">,</span> <span class="n">criteria_dfs</span><span class="p">,</span> <span class="n">criteria_dfs_expanded</span><span class="p">,</span> <span class="n">old_best</span><span class="p">,</span> <span class="n">input_pool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">auto_layer</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">var_select</span><span class="o">=</span><span class="s1">&#39;EN&#39;</span><span class="p">,</span> <span class="n">random</span><span class="o">=</span><span class="s1">&#39;intc&#39;</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">n_iter</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">n_hsi</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">train_cut</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">alphas</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">100</span><span class="p">),</span> <span class="n">l1_ratio</span><span class="o">=</span><span class="p">[</span><span class="mf">.1</span><span class="p">,</span> <span class="mf">.5</span><span class="p">,</span> <span class="mf">.7</span><span class="p">,</span> <span class="mf">.9</span><span class="p">,</span> <span class="mf">.95</span><span class="p">,</span> <span class="mf">.99</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">lags</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">12</span><span class="p">],</span> <span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">coef_select</span><span class="o">=</span><span class="s1">&#39;abs&#39;</span><span class="p">,</span> <span class="n">criteria_dis</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">train_cut</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
        <span class="n">train_cut</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">*</span> <span class="n">train_cut</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        
    <span class="k">if</span> <span class="p">(</span><span class="n">var_select</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;IC&#39;</span><span class="p">,</span> <span class="s1">&#39;coef&#39;</span><span class="p">,</span> <span class="s1">&#39;tvalue&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">random</span><span class="o">==</span><span class="s1">&#39;intc&#39;</span><span class="p">):</span>
        <span class="n">random</span> <span class="o">=</span> <span class="s1">&#39;rnd&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&quot;random&quot; argument turned from &quot;intc&quot; to &quot;rnd&quot;&#39;</span><span class="p">)</span>
        
    <span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">y_train</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">loc</span><span class="p">[:</span><span class="n">train_cut</span><span class="p">]</span>
    
    <span class="n">_</span><span class="p">,</span> <span class="n">X_train_scaled</span> <span class="o">=</span> <span class="n">scale_lag_X</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:],</span> <span class="n">train_cut</span><span class="o">=</span><span class="n">train_cut</span><span class="p">,</span> <span class="n">lagged</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">X_full_scaled</span><span class="p">,</span> <span class="n">X_full_train_scaled</span> <span class="o">=</span> <span class="n">scale_lag_X</span><span class="p">(</span><span class="n">hsi_dfs</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:],</span> <span class="n">train_cut</span><span class="o">=</span><span class="n">train_cut</span><span class="p">,</span> <span class="n">lagged</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">var_select</span> <span class="o">==</span> <span class="s1">&#39;EN&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">input_pool</span><span class="p">:</span>
        <span class="n">X_train_scaled</span> <span class="o">=</span> <span class="n">X_full_train_scaled</span>
    
    <span class="k">if</span> <span class="n">input_pool</span><span class="p">:</span>
        <span class="n">selection_index</span> <span class="o">=</span> <span class="n">hsi_dfs</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">selection_index</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        
    <span class="n">hsi</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="n">criteria_dfs</span> <span class="o">=</span> <span class="n">criteria_dfs</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">hsi_dfs</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="n">criteria_dfs_expanded</span> <span class="o">=</span> <span class="n">criteria_dfs_expanded</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">hsi_dfs</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="n">trends_count_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    
    <span class="k">for</span> <span class="n">lag</span> <span class="ow">in</span> <span class="n">lags</span><span class="p">:</span>
        <span class="n">trends_count</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">X_adj</span> <span class="o">=</span> <span class="n">X_train_scaled</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">lag</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        <span class="n">y_adj</span> <span class="o">=</span> <span class="n">y_train</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">lag</span><span class="p">:]</span>
        
        
        <span class="n">criteria</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">random</span> <span class="o">==</span> <span class="s1">&#39;intc&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">var_select</span> <span class="o">==</span> <span class="s1">&#39;EN&#39;</span><span class="p">:</span>
                <span class="n">elastic_net_cv</span> <span class="o">=</span> <span class="n">ElasticNetCV</span><span class="p">(</span><span class="n">fit_intercept</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alphas</span><span class="o">=</span><span class="n">alphas</span><span class="p">,</span> <span class="n">l1_ratio</span><span class="o">=</span><span class="n">l1_ratio</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">20000</span><span class="p">)</span>
                <span class="n">elastic_net_cv</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_adj</span><span class="p">,</span> <span class="n">y_adj</span><span class="p">)</span> <span class="c1"># I don&#39;t know if it is better to include all exogs in the ElasticNet or just the exog of the last layer</span>
                <span class="n">criteria</span> <span class="o">=</span> <span class="n">elastic_net_cv</span><span class="o">.</span><span class="n">coef_</span>

            <span class="k">elif</span> <span class="n">var_select</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;coef&#39;</span><span class="p">,</span> <span class="s1">&#39;tvalue&#39;</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">X_adj</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="n">model</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">y_adj</span><span class="p">,</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">X_adj</span><span class="p">[[</span><span class="n">feature</span><span class="p">]]))</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">var_select</span> <span class="o">==</span> <span class="s1">&#39;coef&#39;</span><span class="p">:</span>
                        <span class="n">criteria</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">criteria</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="n">var_select</span> <span class="o">==</span> <span class="s1">&#39;tvalue&#39;</span><span class="p">:</span>
                        <span class="n">criteria</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">criteria</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">tvalues</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            
            <span class="k">elif</span> <span class="n">var_select</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;CV&#39;</span><span class="p">,</span> <span class="s1">&#39;IC&#39;</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">X_adj</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="n">ic</span> <span class="o">=</span> <span class="n">compute_ic_cv</span><span class="p">(</span><span class="n">y_adj</span><span class="p">,</span> <span class="n">X_adj</span><span class="p">[[</span><span class="n">feature</span><span class="p">]],</span> <span class="n">metric</span><span class="o">=</span><span class="n">var_select</span><span class="p">,</span> <span class="n">fit_intercept</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="n">cv</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="n">shuffle</span><span class="p">,</span> <span class="n">n_iter</span><span class="o">=</span><span class="n">n_iter</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
                    <span class="n">criteria</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">criteria</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
                
            <span class="n">criteria_dfs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">X_adj</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">var_select</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">lag</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">criteria</span>
            <span class="n">weights_full</span><span class="p">,</span> <span class="n">top_queries</span> <span class="o">=</span> <span class="n">compute_weights</span><span class="p">(</span><span class="n">criteria</span><span class="o">=</span><span class="n">criteria_dfs</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">var_select</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">lag</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">],</span> <span class="n">selection_index</span><span class="o">=</span><span class="n">selection_index</span><span class="p">,</span> <span class="n">var_select</span><span class="o">=</span><span class="n">var_select</span><span class="p">,</span> <span class="n">coef_select</span><span class="o">=</span><span class="n">coef_select</span><span class="p">,</span> <span class="n">power</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">rank_based</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">criteria_dfs</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;weight_</span><span class="si">{</span><span class="n">lag</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">weights_full</span>         

        <span class="k">if</span> <span class="n">random</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_hsi</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">criteria</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
                <span class="k">if</span> <span class="n">random</span> <span class="o">==</span> <span class="s1">&#39;intc&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">var_select</span> <span class="o">==</span> <span class="s1">&#39;EN&#39;</span><span class="p">:</span>
                        <span class="n">df_adj</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">y_adj</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">X_adj</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">shuffle_df_adj</span> <span class="o">=</span> <span class="n">df_adj</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">frac</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">y_adj</span> <span class="o">=</span> <span class="n">shuffle_df_adj</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">X_adj</span> <span class="o">=</span> <span class="n">shuffle_df_adj</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span>
                        <span class="n">elastic_net_cv</span> <span class="o">=</span> <span class="n">ElasticNetCV</span><span class="p">(</span><span class="n">fit_intercept</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">alphas</span><span class="o">=</span><span class="n">alphas</span><span class="p">,</span> <span class="n">l1_ratio</span><span class="o">=</span><span class="n">l1_ratio</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
                        <span class="n">elastic_net_cv</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_adj</span><span class="p">,</span> <span class="n">y_adj</span><span class="p">)</span>
                        <span class="n">criteria</span> <span class="o">=</span> <span class="n">elastic_net_cv</span><span class="o">.</span><span class="n">coef_</span>

                    <span class="k">elif</span> <span class="n">var_select</span> <span class="o">==</span> <span class="s1">&#39;CV&#39;</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">X_adj</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                            <span class="n">ic</span> <span class="o">=</span> <span class="n">compute_ic_cv</span><span class="p">(</span><span class="n">y_adj</span><span class="p">,</span> <span class="n">X_adj</span><span class="p">[[</span><span class="n">feature</span><span class="p">]],</span> <span class="n">metric</span><span class="o">=</span><span class="n">var_select</span><span class="p">,</span> <span class="n">fit_intercept</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="n">cv</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="n">shuffle</span><span class="p">,</span> <span class="n">n_iter</span><span class="o">=</span><span class="n">n_iter</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
                            <span class="n">criteria</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">criteria</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
                    
                    <span class="n">criteria_dfs_expanded</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">X_adj</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">var_select</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">lag</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">criteria</span>
                    <span class="n">_</span><span class="p">,</span> <span class="n">top_queries</span> <span class="o">=</span> <span class="n">compute_weights</span><span class="p">(</span><span class="n">criteria</span><span class="o">=</span><span class="n">criteria_dfs_expanded</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">var_select</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">lag</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">],</span> <span class="n">selection_index</span><span class="o">=</span><span class="n">selection_index</span><span class="p">,</span> <span class="n">var_select</span><span class="o">=</span><span class="n">var_select</span><span class="p">,</span> <span class="n">coef_select</span><span class="o">=</span><span class="n">coef_select</span><span class="p">,</span> <span class="n">power</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">rank_based</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                
                <span class="k">elif</span> <span class="n">random</span> <span class="o">==</span> <span class="s1">&#39;rnd&#39;</span><span class="p">:</span>
                    <span class="n">selection_weights</span> <span class="o">=</span> <span class="n">criteria_dfs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">selection_index</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;weight_</span><span class="si">{</span><span class="n">lag</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">criteria_dfs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">selection_index</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;weight_</span><span class="si">{</span><span class="n">lag</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                    <span class="n">top_queries</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">selection_index</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">selection_weights</span><span class="p">)</span>
                    
                <span class="c1"># Select the n queries with the highest coefficients by their absolute(?) values    </span>
                <span class="n">X_scaled_selected</span> <span class="o">=</span> <span class="n">X_full_scaled</span><span class="p">[</span><span class="n">top_queries</span><span class="p">]</span>
                <span class="n">X_train_scaled_selected</span> <span class="o">=</span> <span class="n">X_full_train_scaled</span><span class="p">[</span><span class="n">top_queries</span><span class="p">]</span>
                <span class="n">trends_count</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">X_scaled_selected</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">var_select</span> <span class="o">==</span> <span class="s1">&#39;EN&#39;</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;hsi_</span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">lag</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s1">,  alpha:</span><span class="si">{</span><span class="n">elastic_net_cv</span><span class="o">.</span><span class="n">alpha_</span><span class="si">}</span><span class="s1">,  l1_ratio: </span><span class="si">{</span><span class="n">elastic_net_cv</span><span class="o">.</span><span class="n">l1_ratio_</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s1"> Selected queries for hsi_</span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">lag</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s1">:</span><span class="se">\n</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X_scaled_selected</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

                <span class="c1"># Apply PCA</span>
                <span class="n">pca</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">principal_component</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled_selected</span><span class="p">)</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_scaled_selected</span><span class="p">)</span>
                <span class="n">hsi</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;hsi_</span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">lag</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">principal_component</span>
            
            <span class="n">values</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">trends_count</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="sa">f</span><span class="s1">&#39;count_</span><span class="si">{</span><span class="n">lag</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">:</span><span class="n">counts</span><span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="n">values</span><span class="p">)</span>
            <span class="n">trends_count_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">trends_count_df</span><span class="p">,</span> <span class="n">a</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">trends_count_df</span> <span class="o">=</span> <span class="n">trends_count_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">trends_count_df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Select the n queries with the highest coefficients by their absolute(?) values</span>
            <span class="n">X_scaled_selected</span> <span class="o">=</span> <span class="n">X_full_scaled</span><span class="p">[</span><span class="n">top_queries</span><span class="p">]</span>
            <span class="n">X_train_scaled_selected</span> <span class="o">=</span> <span class="n">X_full_train_scaled</span><span class="p">[</span><span class="n">top_queries</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">var_select</span> <span class="o">==</span> <span class="s1">&#39;EN&#39;</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;hsi_</span><span class="si">{</span><span class="n">lag</span><span class="si">}</span><span class="s1">,  alpha:</span><span class="si">{</span><span class="n">elastic_net_cv</span><span class="o">.</span><span class="n">alpha_</span><span class="si">}</span><span class="s1">,  l1_ratio:</span><span class="si">{</span><span class="n">elastic_net_cv</span><span class="o">.</span><span class="n">l1_ratio_</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s1"> Selected queries for hsi_</span><span class="si">{</span><span class="n">lag</span><span class="si">}</span><span class="s1">:</span><span class="se">\n</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X_scaled_selected</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="c1"># Apply PCA</span>
            <span class="n">pca</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">principal_component</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled_selected</span><span class="p">)</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_scaled_selected</span><span class="p">)</span>
            <span class="n">hsi</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;hsi_</span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">lag</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">principal_component</span>
            
    <span class="k">if</span> <span class="p">(</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">bool</span><span class="p">(</span><span class="n">random</span><span class="p">):</span>
        <span class="n">display</span><span class="p">(</span><span class="n">trends_count_df</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">random</span> <span class="o">==</span> <span class="s1">&#39;intc&#39;</span><span class="p">:</span>
            <span class="n">display</span><span class="p">(</span><span class="n">criteria_dfs_expanded</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">random</span> <span class="o">==</span> <span class="s1">&#39;intc&#39;</span><span class="p">:</span>
        <span class="n">criteria_dfs</span> <span class="o">=</span> <span class="n">criteria_dfs_expanded</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[:</span><span class="mi">2</span><span class="p">]))</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
        <span class="k">for</span> <span class="n">lag</span> <span class="ow">in</span> <span class="n">lags</span><span class="p">:</span>
            <span class="n">weights</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">compute_weights</span><span class="p">(</span><span class="n">criteria</span><span class="o">=</span><span class="n">criteria_dfs</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">var_select</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">lag</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">],</span> <span class="n">var_select</span><span class="o">=</span><span class="n">var_select</span><span class="p">,</span> <span class="n">coef_select</span><span class="o">=</span><span class="n">coef_select</span><span class="p">,</span> <span class="n">power</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">rank_based</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">criteria_dfs</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;weight_</span><span class="si">{</span><span class="n">lag</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">weights</span>
        <span class="n">criteria_dfs</span> <span class="o">=</span> <span class="n">criteria_dfs</span><span class="p">[[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">lag</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">lag</span> <span class="ow">in</span> <span class="n">lags</span> <span class="k">for</span> <span class="n">title</span> <span class="ow">in</span> <span class="p">[</span><span class="n">var_select</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">]]]</span>
        
        <span class="n">criteria_dfs_expanded</span> <span class="o">=</span> <span class="n">criteria_dfs_expanded</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">criteria_dfs_expanded</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    
    <span class="n">criteria_dfs</span> <span class="o">=</span> <span class="n">criteria_dfs</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">criteria_dfs</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">abs</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">criteria_dis</span><span class="p">:</span>
        <span class="n">display</span><span class="p">(</span><span class="n">criteria_dfs</span><span class="p">)</span>
        
    
    <span class="c1"># `principal_component` now contains the first principal component of the selected search queries</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">hsi</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>    
    <span class="n">hsi_dfs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">hsi_dfs</span><span class="p">,</span> <span class="n">hsi</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">auto_layer</span><span class="p">:</span>
        <span class="n">new_best</span> <span class="o">=</span> <span class="n">criteria_dfs</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">var_select</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="nb">max</span><span class="p">(</span><span class="n">lags</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">layer</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">new_best</span> <span class="o">!=</span> <span class="n">old_best</span><span class="p">:</span>
            <span class="n">hsi_dfs</span><span class="p">,</span> <span class="n">criteria_dfs</span> <span class="o">=</span> <span class="n">pca_hsi</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">hsi_dfs</span><span class="p">,</span> <span class="n">criteria_dfs</span><span class="p">,</span> <span class="n">criteria_dfs_expanded</span><span class="p">,</span> <span class="n">new_best</span><span class="p">,</span> <span class="n">input_pool</span><span class="o">=</span><span class="n">input_pool</span><span class="p">,</span> <span class="n">auto_layer</span><span class="o">=</span><span class="n">auto_layer</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="n">layer</span><span class="p">,</span> <span class="n">var_select</span><span class="o">=</span><span class="n">var_select</span><span class="p">,</span> <span class="n">random</span><span class="o">=</span><span class="n">random</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="n">cv</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="n">shuffle</span><span class="p">,</span> <span class="n">n_iter</span><span class="o">=</span><span class="n">n_iter</span><span class="p">,</span> <span class="n">n_hsi</span><span class="o">=</span><span class="n">n_hsi</span><span class="p">,</span> <span class="n">train_cut</span><span class="o">=</span><span class="n">train_cut</span><span class="p">,</span> <span class="n">alphas</span><span class="o">=</span><span class="n">alphas</span><span class="p">,</span> <span class="n">l1_ratio</span><span class="o">=</span><span class="n">l1_ratio</span><span class="p">,</span> <span class="n">lags</span><span class="o">=</span><span class="n">lags</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">coef_select</span><span class="o">=</span><span class="n">coef_select</span><span class="p">,</span> <span class="n">criteria_dis</span><span class="o">=</span><span class="n">criteria_dis</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span> 
    
    <span class="k">return</span> <span class="n">hsi_dfs</span><span class="p">,</span> <span class="n">criteria_dfs</span>

<span class="c1">#%%</span>

<div class="viewcode-block" id="GT_plot">
<a class="viewcode-back" href="../google_trends_functions.html#google_trends_functions.GT_plot">[docs]</a>
<span class="k">def</span> <span class="nf">GT_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">exog</span><span class="p">,</span> <span class="n">lag</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">winsorize_trend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">scaled</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate plots to visualize the relationship between the Housing Price Index (HPI) and a selected exogenous variable.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        The DataFrame containing the HPI and exogenous variables.</span>
<span class="sd">    exog : str</span>
<span class="sd">        The name of the exogenous variable to be plotted and analyzed.</span>
<span class="sd">    lag : int</span>
<span class="sd">        The lag to apply to the exogenous variable in the scatter plot and time series plot.</span>
<span class="sd">    title : str, optional</span>
<span class="sd">        The title for the overall figure (default is None).</span>
<span class="sd">    winsorize_trend : bool, optional</span>
<span class="sd">        If True, apply winsorization to the exogenous variable to limit the effect of outliers (default is False).</span>
<span class="sd">    scaled : bool, optional</span>
<span class="sd">        If True, standardize the exogenous variable by removing the mean and scaling to unit variance (default is False).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">        Displays a 2x2 grid of plots:</span>
<span class="sd">        - Top-left: Time series plot of HPI.</span>
<span class="sd">        - Top-right: Scatter plot of lagged exogenous variable vs. HPI.</span>
<span class="sd">        - Bottom-left: Time series plot of the lagged exogenous variable.</span>
<span class="sd">        - Bottom-right: (Removed) was intended for an additional plot, now removed.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - The function visualizes the relationship between HPI and a chosen exogenous variable by generating time series and scatter plots.</span>
<span class="sd">    - If `winsorize_trend` is True, the exogenous variable is adjusted to mitigate the impact of extreme values.</span>
<span class="sd">    - If `scaled` is True, the exogenous variable is standardized before being plotted.</span>
<span class="sd">    - The bottom-right subplot (`ax4`) is intentionally removed, leaving three plots in the 2x2 grid.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; model.GT_plot(df, exog=&#39;Google_Trends_Search&#39;, lag=2, title=&#39;Google Trends vs. HPI&#39;, winsorize_trend=True, scaled=True)</span>
<span class="sd">        Displays the plots for the relationship between HPI and the Google Trends search data with a lag of 2.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;mathtext.default&#39;</span><span class="p">:</span> <span class="s1">&#39;regular&#39;</span><span class="p">})</span>
    <span class="c1"># Instead of the above line, we can use terms $\mathregular{N_i}$ and $\mathrm{N_i}$ in setting the label of x-axis and y-axis.</span>
    <span class="c1"># You can one example for ax3 in GT_plot() function</span>
    
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;HPI&#39;</span><span class="p">]]</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="n">exog</span><span class="p">]]</span>
    <span class="k">if</span> <span class="n">winsorize_trend</span><span class="p">:</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">winsorize</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="p">[</span><span class="mf">0.05</span><span class="p">,</span><span class="mf">0.05</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">scaled</span><span class="p">:</span>
        <span class="c1"># Standardize the features</span>
        <span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">scaler</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">loc</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">train_cut</span><span class="p">])</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    
    <span class="n">y_adj</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">lag</span><span class="p">:]</span>
    <span class="n">X_adj</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">lag</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="n">y_adj_train</span> <span class="o">=</span> <span class="n">y_adj</span><span class="o">.</span><span class="n">loc</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">train_cut</span><span class="p">]</span>
    <span class="n">y_adj_val</span> <span class="o">=</span> <span class="n">y_adj</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">train_cut</span><span class="p">:]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">X_adj_train</span> <span class="o">=</span> <span class="n">X_adj</span><span class="o">.</span><span class="n">loc</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">train_cut</span><span class="p">]</span>
    <span class="n">X_adj_val</span> <span class="o">=</span> <span class="n">X_adj</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">train_cut</span><span class="p">:]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    
    <span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),(</span> <span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span> <span class="c1"># figsize=(16,9) | figsize=(16,8)</span>
    <span class="k">if</span> <span class="n">title</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X_adj</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X_adj_train</span><span class="p">,</span> <span class="n">y_adj_train</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#1f77b4&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Train Sample&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X_adj_val</span><span class="p">,</span> <span class="n">y_adj_val</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#ff7f0e&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Validation Sample&#39;</span><span class="p">)</span>
    
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;HPI&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;$HPI_</span><span class="si">{t}</span><span class="s1">$&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_cut</span><span class="p">),</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;train cut&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    
    <span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">exog</span><span class="p">)</span>
    <span class="n">escaped_exog</span> <span class="o">=</span> <span class="n">exog</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;\_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;\ &#39;</span><span class="p">)</span>
    <span class="n">laged_exog</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;$</span><span class="si">{</span><span class="n">escaped_exog</span><span class="si">}</span><span class="s1">_</span><span class="se">{{</span><span class="s1">t-</span><span class="si">{</span><span class="n">lag</span><span class="si">}</span><span class="se">}}</span><span class="s1">$&#39;</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">laged_exog</span><span class="p">)</span>
    <span class="c1"># ax3.set_ylabel(f&#39;$\mathregular{{{escaped_exog}_{{t-{lag}}}}}$&#39;)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_cut</span><span class="p">),</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;train cut&#39;</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">sharex</span><span class="p">(</span><span class="n">ax1</span><span class="p">)</span>
    
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;$HPI_</span><span class="si">{t}</span><span class="s1">$&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Scatter Plot&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">laged_exog</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    
    <span class="n">fig</span><span class="o">.</span><span class="n">delaxes</span><span class="p">(</span><span class="n">ax4</span><span class="p">)</span></div>

    
<span class="c1">#%%</span>

<div class="viewcode-block" id="plot_gtrends">
<a class="viewcode-back" href="../google_trends_functions.html#google_trends_functions.plot_gtrends">[docs]</a>
<span class="k">def</span> <span class="nf">plot_gtrends</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exog</span><span class="p">,</span> <span class="n">h</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span> <span class="n">winsorize_trend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">scaled</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot Google Trends data and its transformations over different stages of processing.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    exog : str or None</span>
<span class="sd">        The exogenous variable (Google Trends search term) to be plotted. If None, the variable with the highest weight for the specified horizon `h` is selected.</span>
<span class="sd">    h : int</span>
<span class="sd">        The forecast horizon to be used. If `h` is not in `self.selection_h_list`, the maximum value from `self.selection_h_list` is used.</span>
<span class="sd">    winsorize_trend : bool, optional</span>
<span class="sd">        If True, the Google Trends data is winsorized (default is False).</span>
<span class="sd">    scaled : bool, optional</span>
<span class="sd">        If True, the Google Trends data is scaled using standardization (default is False).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">        Displays a series of plots showing the original Google Trends data, winsorized data, prepared Google Trends data, and the corresponding Housing Price Index (HPI) data.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - This function visualizes the Google Trends data (`exog`) across different stages: original, after winsorization, after preparation, and after scaling.</span>
<span class="sd">    - The `h` parameter specifies the forecast horizon, and the function adjusts the plots accordingly.</span>
<span class="sd">    - If `exog` is not provided, the function automatically selects the best-performing Google Trends term based on predefined criteria.</span>
<span class="sd">    - The vertical red dashed line in each plot indicates the cut-off point between training and validation data.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; plot_gtrends(exog=&#39;housing_market&#39;, h=6, winsorize_trend=True, scaled=True)</span>
<span class="sd">        Plots the Google Trends data for &#39;housing_market&#39; with winsorization and scaling applied at horizon 6.</span>

<span class="sd">    &gt;&gt;&gt; plot_gtrends(exog=None, h=3)</span>
<span class="sd">        Automatically selects the best Google Trends term and plots it at horizon 3 without any additional processing.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">h</span> <span class="o">=</span> <span class="n">h</span> <span class="k">if</span> <span class="n">h</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">selection_h_list</span> <span class="k">else</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selection_h_list</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">winsorize_trend</span><span class="p">:</span>
        <span class="n">winsorize_trend</span> <span class="o">=</span> <span class="kc">False</span>
        
    <span class="k">if</span> <span class="n">exog</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">gtrends_criteria</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria_dfs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">gtrends_df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:],:]</span>
        <span class="n">exog</span> <span class="o">=</span> <span class="n">gtrends_criteria</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;weight_</span><span class="si">{</span><span class="n">h</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span>
    
    <span class="n">GT_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">,</span> <span class="n">exog</span><span class="o">=</span><span class="n">exog</span><span class="p">,</span> <span class="n">lag</span><span class="o">=</span><span class="n">h</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Original data&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">winsorize_trend</span><span class="p">:</span>
        <span class="n">GT_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">,</span> <span class="n">exog</span><span class="o">=</span><span class="n">exog</span><span class="p">,</span> <span class="n">lag</span><span class="o">=</span><span class="n">h</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;After winsorize gtrend&#39;</span><span class="p">,</span> <span class="n">winsorize_trend</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">GT_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gtrends_df</span><span class="p">,</span> <span class="n">exog</span><span class="o">=</span><span class="n">exog</span><span class="p">,</span> <span class="n">lag</span><span class="o">=</span><span class="n">h</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;After gtrend preparation&#39;</span><span class="p">)</span>
    <span class="n">GT_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hpi_df</span><span class="p">,</span> <span class="n">exog</span><span class="o">=</span><span class="n">exog</span><span class="p">,</span> <span class="n">lag</span><span class="o">=</span><span class="n">h</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;After HPI preparation&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">scaled</span><span class="p">:</span>
        <span class="n">GT_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hpi_df</span><span class="p">,</span> <span class="n">exog</span><span class="o">=</span><span class="n">exog</span><span class="p">,</span> <span class="n">lag</span><span class="o">=</span><span class="n">h</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Scaled gtrends&#39;</span><span class="p">,</span> <span class="n">scaled</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

        
<span class="c1">#%%</span>

<div class="viewcode-block" id="plot_hsi">
<a class="viewcode-back" href="../google_trends_functions.html#google_trends_functions.plot_hsi">[docs]</a>
<span class="k">def</span> <span class="nf">plot_hsi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hsi</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot the selected Housing Search Index (HSI) for different forecast horizons.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    hsi : str, optional</span>
<span class="sd">        The specific HSI to be plotted. If None, the HSI with the highest weight for each forecast horizon (`h`) is selected (default is None).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">        Displays the plots for the selected HSIs across the specified forecast horizons in `self.selection_h_list`.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - This method generates a plot for each forecast horizon (`h`) in reverse order (starting from the longest horizon).</span>
<span class="sd">    - If no specific `hsi` is provided, the method will automatically select and plot the HSI with the maximum weight for each `h` from `self.criteria_dfs`.</span>
<span class="sd">    - The plots are created using the `GT_plot` function, which visualizes the relationship between the HPI and the selected HSI.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; model.plot_hsi(hsi=&#39;Sentiment_Index&#39;)</span>
<span class="sd">        Plots the specified &#39;Sentiment_Index&#39; for all horizons in the selection list.</span>
<span class="sd">        </span>
<span class="sd">    &gt;&gt;&gt; model.plot_hsi()</span>
<span class="sd">        Automatically selects and plots the HSI with the maximum weight for each horizon in the selection list.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selection_h_list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selection_h_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">hsi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria_dfs</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;weight_</span><span class="si">{</span><span class="n">h</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span> <span class="k">if</span> <span class="n">hsi</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">hsi</span>
        <span class="n">GT_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hsi_dfs</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;hsi=</span><span class="si">{</span><span class="n">hsi</span><span class="si">}</span><span class="s1">, h=</span><span class="si">{</span><span class="n">h</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">exog</span><span class="o">=</span><span class="n">hsi</span><span class="p">,</span> <span class="n">lag</span><span class="o">=</span><span class="n">h</span><span class="p">)</span></div>


<span class="c1">#%%</span>

<div class="viewcode-block" id="plot_improvement">
<a class="viewcode-back" href="../google_trends_functions.html#google_trends_functions.plot_improvement">[docs]</a>
<span class="k">def</span> <span class="nf">plot_improvement</span><span class="p">(</span><span class="n">obj_list</span><span class="p">,</span> <span class="n">measure</span><span class="o">=</span><span class="s1">&#39;MAFE&#39;</span><span class="p">,</span> <span class="n">h_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">9</span><span class="p">)):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot the Kernel Density Estimate (KDE) of improvement measures (MAFE/MSFE) for different models across forecast horizons.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    obj_list : list</span>
<span class="sd">        A list of objects containing the results of the models to be compared. Each object should have `MAFE_val_df_improve` and `MSFE_val_df_improve` attributes.</span>
<span class="sd">    measure : str, optional</span>
<span class="sd">        The performance measure to be plotted. Can be &#39;MAFE&#39; (Mean Absolute Forecast Error) or &#39;MSFE&#39; (Mean Squared Forecast Error). Default is &#39;MAFE&#39;.</span>
<span class="sd">    h_list : list, optional</span>
<span class="sd">        The list of forecast horizons to be considered. If None, the horizons from the first object in `obj_list` will be used.</span>
<span class="sd">    colors : list, optional</span>
<span class="sd">        List of colors to be used for plotting different models. If None, a default list of colors will be used.</span>
<span class="sd">    labels : list, optional</span>
<span class="sd">        List of labels for the models in `obj_list`. If None, default labels (&#39;G1&#39;, &#39;G2&#39;, ...) will be generated.</span>
<span class="sd">    figsize : tuple, optional</span>
<span class="sd">        Size of the figure. Default is (15, 9).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">        Displays the KDE plots for the selected measure across the specified forecast horizons.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - This function plots the density of the percentage improvement in MAFE/MSFE for different models over multiple forecast horizons (`h`).</span>
<span class="sd">    - A vertical line is added to each plot to mark the performance of the Universal Housing Sentiment Index (UHSI) for the corresponding forecast horizon.</span>
<span class="sd">    - If `h_list` is not provided, the forecast horizons from the first model in `obj_list` are used by default.</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; plot_improvement(models_list, measure=&#39;MAFE&#39;, h_list=[1, 3, 6, 12], colors=[&#39;blue&#39;, &#39;orange&#39;], labels=[&#39;Model 1&#39;, &#39;Model 2&#39;])</span>
<span class="sd">        Plots the MAFE improvement KDE for the specified models and forecast horizons.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;mathtext.default&#39;</span><span class="p">:</span> <span class="s1">&#39;regular&#39;</span><span class="p">})</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">h_list</span><span class="p">:</span>
        <span class="n">h_list</span> <span class="o">=</span> <span class="n">obj_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">h_list</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">colors</span><span class="p">:</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="s1">&#39;purple&#39;</span><span class="p">,</span> <span class="s1">&#39;yellow&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">labels</span><span class="p">:</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;G</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj_list</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
    
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">h_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">h_list</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span><span class="mi">2</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        
    <span class="c1"># fig.suptitle(f&#39;{measure} Improvement KDE Plot&#39;)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">supxlabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">measure</span><span class="si">}</span><span class="s1"> Improvement in percent&#39;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">supylabel</span><span class="p">(</span><span class="s1">&#39;Density&#39;</span><span class="p">)</span>
    <span class="n">axs</span> <span class="o">=</span> <span class="n">axs</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">h_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="p">[</span><span class="n">axs</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="n">measure</span> <span class="o">==</span> <span class="s1">&#39;MAFE&#39;</span><span class="p">:</span>
        <span class="n">df_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">MAFE_val_df_improve</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">obj_list</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">measure</span> <span class="o">==</span> <span class="s1">&#39;MSFE&#39;</span><span class="p">:</span>
        <span class="n">df_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">MSFE_val_df_improve</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">obj_list</span><span class="p">]</span>
        
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">h_list</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">df_list</span><span class="p">):</span>
            <span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span><span class="n">i</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;$</span><span class="si">{</span><span class="n">labels</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="si">}</span><span class="s1">\ B_</span><span class="se">{{</span><span class="si">{</span><span class="n">h</span><span class="si">}</span><span class="se">}}</span><span class="s1">$&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
            <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;UHSI_</span><span class="si">{</span><span class="n">h</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">],</span> <span class="n">color</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">labels</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="si">}</span><span class="s1"> UHSI_</span><span class="si">{</span><span class="n">h</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            
        <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;h=</span><span class="si">{</span><span class="n">h</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="c1"># axs[i].xaxis.label.set_visible(False)</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">,</span> <span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">9</span><span class="p">})</span></div>

        
<span class="c1">#%%</span>

<div class="viewcode-block" id="plot_forecast">
<a class="viewcode-back" href="../google_trends_functions.html#google_trends_functions.plot_forecast">[docs]</a>
<span class="k">def</span> <span class="nf">plot_forecast</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exog</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot the forecasted vs actual Housing Price Index (HPI) values over different forecast horizons.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    exog : str or list, optional</span>
<span class="sd">        The exogenous variable(s) used in the forecasting models. If None, the best performing exogenous variable for each horizon is selected based on the criteria in `self.forecast_criteria_df`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">        Displays the forecast plots for the actual and predicted HPI across different forecast horizons.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - The function generates subplots for each forecast horizon `h` in `self.h_list`, displaying the actual and predicted HPI.</span>
<span class="sd">    - If `exog` is a list, the corresponding element is used as the exogenous variable for each horizon. If `exog` is a single string, it is used for all horizons.</span>
<span class="sd">    - The vertical red dashed line marks the cut-off point between the training and validation datasets.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; model.plot_forecast(exog=[&#39;UHSI_1&#39;, &#39;UHSI_3&#39;, &#39;UHSI_6&#39;])</span>
<span class="sd">        Plots the forecasts using the specified exogenous variables for each horizon.</span>

<span class="sd">    &gt;&gt;&gt; model.plot_forecast(exog=&#39;UHSI_3&#39;)</span>
<span class="sd">        Plots the forecasts using &#39;UHSI_3&#39; as the exogenous variable for all horizons.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">exog</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">exog</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">forecast_criteria_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()))</span>
    
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h_list</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span><span class="mi">2</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">9</span><span class="p">))</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Forecast&#39;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">supxlabel</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">supylabel</span><span class="p">(</span><span class="s1">&#39;log HPI&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_scale</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">supylabel</span><span class="p">(</span><span class="s1">&#39;HPI&#39;</span><span class="p">)</span>
    <span class="n">axs</span> <span class="o">=</span> <span class="n">axs</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h_list</span><span class="p">):</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forecast_dict</span><span class="p">[</span><span class="n">h</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;HPI&#39;</span><span class="p">]</span>
        <span class="n">model_exog</span> <span class="o">=</span> <span class="n">exog</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exog</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">exog</span>
        <span class="n">Y_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forecast_dict</span><span class="p">[</span><span class="n">h</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">model_exog</span><span class="p">]</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Actual&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Y_pred</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Prediction&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;h=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">h</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;, exog=&#39;</span> <span class="o">+</span> <span class="n">model_exog</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_cut</span><span class="p">),</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;train cut&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span></div>







<span class="c1"># ******************* Google Trend Classes ***************************</span>
<span class="c1">#%%</span>

<div class="viewcode-block" id="GoogleTrend">
<a class="viewcode-back" href="../google_trends_functions.html#google_trends_functions.GoogleTrend">[docs]</a>
<span class="k">class</span> <span class="nc">GoogleTrend</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class for processing and modeling Google Trends data to predict housing prices.</span>
<span class="sd">    This class provides tools for preparing, transforming, and modeling time series data using methods such as detrending,</span>
<span class="sd">    deseasonalizing, principal component analysis (PCA), and lagged variable selection.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pd.DataFrame</span>
<span class="sd">        A DataFrame containing the initial dataset, including the Housing Price Index (HPI) and Google Trends data.</span>
<span class="sd">    train_cut : float, int, or str, optional</span>
<span class="sd">        Defines the end of the training period. If a float between 0 and 1 is provided, it represents the fraction of the dataset used for training. Default is 0.8.</span>
<span class="sd">    verbose : bool, optional</span>
<span class="sd">        If True, enables detailed output for logging purposes. Default is False.</span>
<span class="sd">    seed : int or None, optional</span>
<span class="sd">        Seed for random number generation, used to ensure reproducibility. Default is None.</span>
<span class="sd">    pca_lag : bool, optional</span>
<span class="sd">        If True, PCA with lagged variables is used during the feature extraction. Default is True.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pd.DataFrame</span>
<span class="sd">        A copy of the initial dataset provided by the user.</span>
<span class="sd">    train_cut : pd.Timestamp</span>
<span class="sd">        Timestamp or index defining the end of the training period.</span>
<span class="sd">    verbose : bool</span>
<span class="sd">        Verbosity level for logging purposes.</span>
<span class="sd">    seed : int or None</span>
<span class="sd">        Seed for random number generation.</span>
<span class="sd">    pca_lag : bool</span>
<span class="sd">        Specifies whether PCA with lagged variables should be used.</span>
<span class="sd">    gtrends_df : pd.DataFrame</span>
<span class="sd">        Transformed Google Trends data.</span>
<span class="sd">    hpi_df : pd.DataFrame</span>
<span class="sd">        Transformed Housing Price Index (HPI) data.</span>
<span class="sd">    hsi_df : pd.DataFrame</span>
<span class="sd">        Final set of features generated after processing HPI and Google Trends data.</span>
<span class="sd">    hsi_dfs : pd.DataFrame</span>
<span class="sd">        Collection of transformed features including multiple PCA layers.</span>
<span class="sd">    criteria_dfs : pd.DataFrame</span>
<span class="sd">        DataFrame containing computed criteria values for feature selection.</span>
<span class="sd">    criteria_dfs_expanded : pd.DataFrame</span>
<span class="sd">        DataFrame containing expanded versions of computed criteria for feature selection.</span>
<span class="sd">    forecast_hsi : pd.DataFrame</span>
<span class="sd">        The final set of features used for forecasting.</span>
<span class="sd">    MAFE_val_df, MSFE_val_df, forecast_criteria_df, etc.</span>
<span class="sd">        DataFrames and metrics representing model performance during the forecast.</span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    prepare_gtrends(detrend=True, deseasonal=True, ...)</span>
<span class="sd">        Prepares Google Trends data by applying optional transformations such as detrending and deseasonalizing.</span>
<span class="sd">    prepare_hpi(detrend=False, deseasonal=True, ...)</span>
<span class="sd">        Prepares the HPI data by applying optional transformations such as detrending and deseasonalizing.</span>
<span class="sd">    compute_hsi(layer=1, ...)</span>
<span class="sd">        Extracts key features from the dataset using PCA, lagged variables, and selection criteria.</span>
<span class="sd">    lag_setting(lag_select=&#39;IC&#39;, ...)</span>
<span class="sd">        Sets the lag selection criteria and related parameters for the model.</span>
<span class="sd">    forecast(h_list=[1,3,6,12], ...)</span>
<span class="sd">        Forecasts the HPI using prepared Google Trends data and selected lags.</span>
<span class="sd">    results(results_table=False, ...)</span>
<span class="sd">        Displays various results from the model, including performance metrics.</span>
<span class="sd">    plot_gtrends(exog=None, ...)</span>
<span class="sd">        Plots Google Trends data used in the model.</span>
<span class="sd">    plot_hsi(hsi=None)</span>
<span class="sd">        Plots HSI data used in the model.</span>
<span class="sd">    plot_improvement(measure=&#39;MAFE&#39;, ...)</span>
<span class="sd">        Plots improvements in forecasting accuracy based on specified performance measures.</span>
<span class="sd">    plot_forecast(exog=None)</span>
<span class="sd">        Plots the forecasted HPI based on the selected model features.</span>
<span class="sd">        </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; GT_object = GoogleTrend(df, &#39;2019-12-31&#39;, verbose=1, seed=1, pca_lag=True)</span>
<span class="sd">    &gt;&gt;&gt; GT_object.prepare_gtrends(detrend=True, deseasonal=True, method=&#39;reg&#39;, regression=&#39;ct&#39;, log=False, smooth=12)</span>
<span class="sd">    &gt;&gt;&gt; GT_object.prepare_hpi(detrend=True, deseasonal=True, method=&#39;reg&#39;, regression=&#39;ct&#39;, log=True)</span>
<span class="sd">    &gt;&gt;&gt; GT_object.compute_hsi(layer=1, input_pool=True, auto_layer=False, n_input=10, n_hsi=20, max_lag=3, var_select=&#39;CV&#39;, random=&#39;rnd&#39;, cv=5, shuffle=True, n_iter=20, selection_h_list=[0,1,3,6,12])</span>
<span class="sd">    &gt;&gt;&gt; GT_object.compute_hsi(layer=2, input_pool=True, auto_layer=True, n_input=10, n_hsi=20, max_lag=1, var_select=&#39;CV&#39;, random=&#39;rnd&#39;, cv=5, shuffle=True, n_iter=20, selection_h_list=[0,1,3,6,12])</span>
<span class="sd">    &gt;&gt;&gt; GT_object.lag_setting(y_lags=&#39;Auto&#39;, exog_lags=&#39;Auto&#39;, max_lag=3, lag_select=&#39;IC&#39;)</span>
<span class="sd">    &gt;&gt;&gt; GT_object.forecast(h_list=[1,3,6,12], seasonal=True, hsi_CV_select=True, fit_intercept=True, cv=5, n_iter=20, original_scale=False)</span>
<span class="sd">    &gt;&gt;&gt; GT_object.results(MAFE_val_df=True, MAFE_val_df_improve=True, forecast_criteria_df=True, lags_df=True, head=True)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">train_cut</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pca_lag</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_cut</span> <span class="o">=</span> <span class="n">train_cut</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="n">seed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pca_lag</span> <span class="o">=</span> <span class="n">pca_lag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_cut</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">train_cut</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_cut</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">X_scaled_lagged_full</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">criteria_dfs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">criteria_dfs_expanded</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    
<div class="viewcode-block" id="GoogleTrend.prepare_gtrends">
<a class="viewcode-back" href="../google_trends_functions.html#google_trends_functions.GoogleTrend.prepare_gtrends">[docs]</a>
    <span class="k">def</span> <span class="nf">prepare_gtrends</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">deseasonal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;reg&#39;</span><span class="p">,</span> <span class="n">regression</span><span class="o">=</span><span class="s1">&#39;ct&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">smooth</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">winsorize</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepares Google Trends data by applying optional transformations such as detrending, deseasonalizing, smoothing, and logging.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        detrend : bool, optional</span>
<span class="sd">            If True, removes the trend component from the Google Trends data. Default is True.</span>
<span class="sd">        deseasonal : bool, optional</span>
<span class="sd">            If True, removes the seasonal component from the Google Trends data. Default is True.</span>
<span class="sd">        method : str, optional</span>
<span class="sd">            The method used for detrending and/or deseasonalizing. Options are &#39;reg&#39; for regression-based, &#39;MA&#39; for moving average, or &#39;growth&#39; for differencing. Default is &#39;reg&#39;.</span>
<span class="sd">        regression : str, optional</span>
<span class="sd">            The type of regression to use for detrending. Options are &#39;c&#39; (constant), &#39;ct&#39; (constant + trend), or &#39;ctt&#39; (constant + trend + quadratic trend). Used only if `method=&#39;reg&#39;`. Default is &#39;ct&#39;.</span>
<span class="sd">        alpha : float, optional</span>
<span class="sd">            The significance level for the augmented Dickey-Fuller (ADF) test used in the regression-based method. Default is 0.15.</span>
<span class="sd">        log : bool, optional</span>
<span class="sd">            If True, log-transforms the Google Trends data by applying `log(X + 1)` to stabilize variance. Default is False.</span>
<span class="sd">        smooth : bool or int, optional</span>
<span class="sd">            If True, applies smoothing using a default window of 12. If an integer is provided, it specifies the window size for smoothing. Default is False.</span>
<span class="sd">        winsorize : bool, optional</span>
<span class="sd">            If True, applies winsorization to the Google Trends data to reduce the effect of outliers. Default is False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">            Updates the `gtrends_df` attribute with the prepared Google Trends data after applying the specified transformations.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        - This method prepares the Google Trends data for further modeling by optionally removing trend and seasonal components, smoothing, and log-transforming the data.</span>
<span class="sd">        - The `method` parameter determines the approach for detrending and deseasonalizing, allowing flexibility in how these transformations are applied.</span>
<span class="sd">        - The transformations help stabilize the data, improve stationarity, and reduce the impact of outliers, which can enhance the performance of downstream models.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">winsorize_trend</span> <span class="o">=</span> <span class="n">winsorize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gtrends_df</span> <span class="o">=</span> <span class="n">prepare_gtrends</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="n">detrend</span><span class="p">,</span> <span class="n">deseasonal</span><span class="o">=</span><span class="n">deseasonal</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">regression</span><span class="o">=</span><span class="n">regression</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="n">log</span><span class="p">,</span> <span class="n">smooth</span><span class="o">=</span><span class="n">smooth</span><span class="p">,</span> <span class="n">winsorize_trends</span><span class="o">=</span><span class="n">winsorize</span><span class="p">,</span> <span class="n">train_cut</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">train_cut</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="GoogleTrend.prepare_hpi">
<a class="viewcode-back" href="../google_trends_functions.html#google_trends_functions.GoogleTrend.prepare_hpi">[docs]</a>
    <span class="k">def</span> <span class="nf">prepare_hpi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">deseasonal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;reg&#39;</span><span class="p">,</span> <span class="n">regression</span><span class="o">=</span><span class="s1">&#39;ct&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepares the Housing Price Index (HPI) data by applying optional transformations such as detrending, deseasonalizing, and logging.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        detrend : bool, optional</span>
<span class="sd">            If True, removes the trend component from the HPI data. Default is False.</span>
<span class="sd">        deseasonal : bool, optional</span>
<span class="sd">            If True, removes the seasonal component from the HPI data. Default is True.</span>
<span class="sd">        method : str, optional</span>
<span class="sd">            The method used for detrending and/or deseasonalizing. Options are &#39;reg&#39; for regression-based or &#39;MA&#39; for moving average. Default is &#39;reg&#39;.</span>
<span class="sd">        regression : str, optional</span>
<span class="sd">            The type of regression to use for detrending. Options are &#39;c&#39; (constant), &#39;ct&#39; (constant + trend), or &#39;ctt&#39; (constant + trend + quadratic trend). Used only if `method=&#39;reg&#39;`. Default is &#39;ct&#39;.</span>
<span class="sd">        alpha : float, optional</span>
<span class="sd">            The significance level for the augmented Dickey-Fuller (ADF) test used in the regression-based method. Default is 0.15.</span>
<span class="sd">        log : bool, optional</span>
<span class="sd">            If True, log-transforms the HPI data by applying `log(HPI)`. Default is False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">            Updates the `hpi_df` attribute with the prepared HPI data after applying the specified transformations.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        - This method prepares the Housing Price Index (HPI) data for further modeling by optionally removing trend and seasonal components and applying a log transformation.</span>
<span class="sd">        - The `method` parameter determines how the detrending and deseasonalizing are applied, offering flexibility in transformations.</span>
<span class="sd">        - The transformations help in stabilizing the variance, improving stationarity, and making the data suitable for time series modeling and forecasting.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">log</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">original_hpi</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">detrend</span> <span class="o">|</span> <span class="n">deseasonal</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">original_hpi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">HPI</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hpi_df</span> <span class="o">=</span> <span class="n">prepare_hpi</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gtrends_df</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="n">detrend</span><span class="p">,</span> <span class="n">deseasonal</span><span class="o">=</span><span class="n">deseasonal</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">regression</span><span class="o">=</span><span class="n">regression</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="n">log</span><span class="p">,</span> <span class="n">train_cut</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">train_cut</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hsi_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hpi_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hsi_dfs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hpi_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span></div>

        
<div class="viewcode-block" id="GoogleTrend.compute_hsi">
<a class="viewcode-back" href="../google_trends_functions.html#google_trends_functions.GoogleTrend.compute_hsi">[docs]</a>
    <span class="k">def</span> <span class="nf">compute_hsi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">input_pool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">auto_layer</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">n_input</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">n_hsi</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">max_lag</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">var_select</span><span class="o">=</span><span class="s1">&#39;CV&#39;</span><span class="p">,</span> <span class="n">random</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">n_iter</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">alphas</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">l1_ratio</span><span class="o">=</span><span class="p">[</span><span class="mf">.1</span><span class="p">,</span> <span class="mf">.5</span><span class="p">,</span> <span class="mf">.7</span><span class="p">,</span> <span class="mf">.9</span><span class="p">,</span> <span class="mf">.95</span><span class="p">,</span> <span class="mf">.99</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">selection_h_list</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">12</span><span class="p">],</span> <span class="n">coef_select</span><span class="o">=</span><span class="s1">&#39;abs&#39;</span><span class="p">,</span> <span class="n">criteria_dis</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extracts key features from the dataset using Principal Component Analysis (PCA), lagged variables, and feature selection criteria.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        layer : int, optional</span>
<span class="sd">            The current layer of PCA and feature extraction. Default is 1.</span>
<span class="sd">        input_pool : bool, optional</span>
<span class="sd">            If True, the full input feature pool is used during the feature extraction. Default is True.</span>
<span class="sd">        auto_layer : bool, optional</span>
<span class="sd">            If True, additional layers are added automatically until no improvement is observed. Default is False.</span>
<span class="sd">        n_input : int, optional</span>
<span class="sd">            Number of input features to select. Default is 10.</span>
<span class="sd">        n_hsi : int, optional</span>
<span class="sd">            Number of HSI (Housing Sentiment Index) features to compute. Default is 20.</span>
<span class="sd">        max_lag : int, optional</span>
<span class="sd">            Maximum lag to consider for lagged features. Default is 3.</span>
<span class="sd">        var_select : str, optional</span>
<span class="sd">            The method used for variable selection. Options include &#39;CV&#39;, &#39;EN&#39;, &#39;coef&#39;, or &#39;tvalue&#39;. Default is &#39;CV&#39;.</span>
<span class="sd">        random : bool or str, optional</span>
<span class="sd">            If True or set to &#39;intc&#39; or &#39;rnd&#39;, a randomized selection process is used. Default is False.</span>
<span class="sd">        cv : int, optional</span>
<span class="sd">            Number of cross-validation folds. Default is 3.</span>
<span class="sd">        shuffle : bool, optional</span>
<span class="sd">            If True, shuffle the data during cross-validation. Default is True.</span>
<span class="sd">        n_iter : int, optional</span>
<span class="sd">            Number of iterations for randomized search or selection. Default is 20.</span>
<span class="sd">        alphas : array-like, optional</span>
<span class="sd">            Array of alpha values for ElasticNetCV. Default is np.logspace(-3, 0, 100).</span>
<span class="sd">        l1_ratio : list, optional</span>
<span class="sd">            List of L1 ratios for ElasticNetCV. Default is [.1, .5, .7, .9, .95, .99, 1].</span>
<span class="sd">        selection_h_list : list of int, optional</span>
<span class="sd">            List of lag periods to consider for selection. Default is [0, 1, 3, 6, 12].</span>
<span class="sd">        coef_select : str, optional</span>
<span class="sd">            Method for selecting coefficients (&#39;abs&#39; for absolute values or &#39;neg&#39; for negative values). Default is &#39;abs&#39;.</span>
<span class="sd">        criteria_dis : bool, optional</span>
<span class="sd">            If True, displays criteria DataFrames used in feature selection. Default is False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">            Updates the attributes `hsi_df`, `hsi_dfs`, `X_scaled_lagged_full`, `criteria_dfs`, and `forecast_hsi` with the newly computed features and criteria.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        - This method uses PCA for dimensionality reduction and lagged variable selection to generate new features.</span>
<span class="sd">        - Feature selection is based on different criteria, including ElasticNet coefficients, cross-validation metrics, and other statistics.</span>
<span class="sd">        - The process can include both deterministic and randomized approaches to ensure robustness.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">alphas</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">alphas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">100</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var_select</span> <span class="o">=</span> <span class="n">var_select</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">random</span> <span class="o">=</span> <span class="n">random</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">selection_h_list</span> <span class="o">=</span> <span class="n">selection_h_list</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pca_lag</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hsi_df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hsi_dfs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_scaled_lagged_full</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria_dfs</span> <span class="o">=</span> <span class="n">pca_hsi_dif_lags</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hsi_df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hsi_dfs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_scaled_lagged_full</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria_dfs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria_dfs_expanded</span><span class="p">,</span> <span class="n">old_best</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">input_pool</span><span class="o">=</span><span class="n">input_pool</span><span class="p">,</span> <span class="n">auto_layer</span><span class="o">=</span><span class="n">auto_layer</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="n">layer</span><span class="p">,</span> <span class="n">max_lag</span><span class="o">=</span><span class="n">max_lag</span><span class="p">,</span> <span class="n">var_select</span><span class="o">=</span><span class="n">var_select</span><span class="p">,</span> <span class="n">random</span><span class="o">=</span><span class="n">random</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="n">cv</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="n">shuffle</span><span class="p">,</span> <span class="n">n_iter</span><span class="o">=</span><span class="n">n_iter</span><span class="p">,</span> <span class="n">n_hsi</span><span class="o">=</span><span class="n">n_hsi</span><span class="p">,</span> <span class="n">train_cut</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">train_cut</span><span class="p">,</span> <span class="n">alphas</span><span class="o">=</span><span class="n">alphas</span><span class="p">,</span> <span class="n">l1_ratio</span><span class="o">=</span><span class="n">l1_ratio</span><span class="p">,</span> <span class="n">lags</span><span class="o">=</span><span class="n">selection_h_list</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n_input</span><span class="p">,</span> <span class="n">coef_select</span><span class="o">=</span><span class="n">coef_select</span><span class="p">,</span> <span class="n">criteria_dis</span><span class="o">=</span><span class="n">criteria_dis</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hsi_df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hsi_dfs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria_dfs</span> <span class="o">=</span> <span class="n">pca_hsi</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hsi_df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hsi_dfs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria_dfs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria_dfs_expanded</span><span class="p">,</span> <span class="n">old_best</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">input_pool</span><span class="o">=</span><span class="n">input_pool</span><span class="p">,</span> <span class="n">auto_layer</span><span class="o">=</span><span class="n">auto_layer</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="n">layer</span><span class="p">,</span> <span class="n">var_select</span><span class="o">=</span><span class="n">var_select</span><span class="p">,</span> <span class="n">random</span><span class="o">=</span><span class="n">random</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="n">cv</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="n">shuffle</span><span class="p">,</span> <span class="n">n_iter</span><span class="o">=</span><span class="n">n_iter</span><span class="p">,</span> <span class="n">n_hsi</span><span class="o">=</span><span class="n">n_hsi</span><span class="p">,</span> <span class="n">train_cut</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">train_cut</span><span class="p">,</span> <span class="n">alphas</span><span class="o">=</span><span class="n">alphas</span><span class="p">,</span> <span class="n">l1_ratio</span><span class="o">=</span><span class="n">l1_ratio</span><span class="p">,</span> <span class="n">lags</span><span class="o">=</span><span class="n">selection_h_list</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n_input</span><span class="p">,</span> <span class="n">coef_select</span><span class="o">=</span><span class="n">coef_select</span><span class="p">,</span> <span class="n">criteria_dis</span><span class="o">=</span><span class="n">criteria_dis</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">input_pool</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">forecast_hsi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hsi_dfs</span><span class="p">[[</span><span class="s1">&#39;HPI&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">criteria_dfs</span><span class="o">.</span><span class="n">index</span><span class="p">[:(</span><span class="n">n_hsi</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">selection_h_list</span><span class="p">))])]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">auto_layer</span><span class="p">:</span>
                <span class="n">last_layer</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hsi_dfs</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;hsi&#39;</span><span class="p">)])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">forecast_hsi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hsi_dfs</span><span class="p">[[</span><span class="s1">&#39;HPI&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hsi_dfs</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;hsi_</span><span class="si">{</span><span class="n">last_layer</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">forecast_hsi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hsi_df</span></div>


<div class="viewcode-block" id="GoogleTrend.lag_setting">
<a class="viewcode-back" href="../google_trends_functions.html#google_trends_functions.GoogleTrend.lag_setting">[docs]</a>
    <span class="k">def</span> <span class="nf">lag_setting</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_lags</span><span class="o">=</span><span class="s1">&#39;Auto&#39;</span><span class="p">,</span> <span class="n">exog_lags</span><span class="o">=</span><span class="s1">&#39;Auto&#39;</span><span class="p">,</span> <span class="n">max_lag</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">lag_select</span><span class="o">=</span><span class="s1">&#39;IC&#39;</span><span class="p">,</span> <span class="n">fit_intercept</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">n_iter</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">var_order</span><span class="o">=</span><span class="s1">&#39;cross&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the lag selection criteria and related parameters for the model.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        lag_select : str, optional</span>
<span class="sd">            The method used for selecting the lag order. Options include &#39;IC&#39; (information criterion), &#39;CV&#39; (cross-validation), etc. Default is &#39;IC&#39;.</span>
<span class="sd">        fit_intercept : bool, optional</span>
<span class="sd">            If True, fits an intercept in the lag model. Default is False.</span>
<span class="sd">        cv : int, optional</span>
<span class="sd">            Number of cross-validation folds to use when selecting lags. Default is 5.</span>
<span class="sd">        shuffle : bool, optional</span>
<span class="sd">            If True, shuffle the data during cross-validation. Default is True.</span>
<span class="sd">        n_iter : int, optional</span>
<span class="sd">            Number of iterations to use during randomized cross-validation or lag selection. Default is 20.</span>
<span class="sd">        var_order : str, optional</span>
<span class="sd">            The order in which variables are considered for lag selection. Options include &#39;cross&#39; (cross-sectional ordering) and others. Default is &#39;cross&#39;.</span>
<span class="sd">        max_lag : int, optional</span>
<span class="sd">            The maximum lag to consider for the model. Default is 3.</span>
<span class="sd">        y_lags : str or int, optional</span>
<span class="sd">            The number of lags for the target variable (`y`). If &#39;Auto&#39;, the lag length is automatically determined. Default is &#39;Auto&#39;.</span>
<span class="sd">        exog_lags : str or int, optional</span>
<span class="sd">            The number of lags for the exogenous variables (`exog`). If &#39;Auto&#39;, the lag length is automatically determined. Default is &#39;Auto&#39;.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">            Updates the lag-related attributes of the instance, such as `lag_select`, `lag_fit_intercept`, `lag_cv`, and others.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        - This method sets the parameters for the lag selection process, which determines the temporal dependencies in the model.</span>
<span class="sd">        - The selection can be done using either information criteria or cross-validation approaches.</span>
<span class="sd">        - The `var_order` parameter controls the order in which variables are processed for lag determination, which can impact model performance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">lag_select</span> <span class="o">=</span> <span class="n">lag_select</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lag_fit_intercept</span> <span class="o">=</span> <span class="n">fit_intercept</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lag_cv</span> <span class="o">=</span> <span class="n">cv</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var_order</span> <span class="o">=</span> <span class="n">var_order</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_lag</span> <span class="o">=</span> <span class="n">max_lag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_lags</span> <span class="o">=</span> <span class="n">y_lags</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exog_lags</span> <span class="o">=</span> <span class="n">exog_lags</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span> <span class="o">=</span> <span class="n">shuffle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lag_iter</span> <span class="o">=</span> <span class="n">n_iter</span></div>

    
<div class="viewcode-block" id="GoogleTrend.forecast">
<a class="viewcode-back" href="../google_trends_functions.html#google_trends_functions.GoogleTrend.forecast">[docs]</a>
    <span class="k">def</span> <span class="nf">forecast</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h_list</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">12</span><span class="p">],</span> <span class="n">seasonal</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">hsi_CV_select</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fit_intercept</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">n_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">original_scale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sort_df</span><span class="o">=</span><span class="s1">&#39;criteria&#39;</span><span class="p">,</span>  <span class="n">sort_col</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Forecasts the Housing Price Index (HPI) using prepared Google Trends data and selected lag features.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        h_list : list of int, optional</span>
<span class="sd">            A list of forecast horizons for which the predictions will be made. Default is [1, 3, 6, 12].</span>
<span class="sd">        seasonal : bool, optional</span>
<span class="sd">            If True, includes seasonal components in the model during forecasting. Default is False.</span>
<span class="sd">        hsi_CV_select : bool, optional</span>
<span class="sd">            If True, uses cross-validation for selecting the Housing Sentiment Index (HSI) features. Default is False.</span>
<span class="sd">        fit_intercept : bool, optional</span>
<span class="sd">            If True, fits an intercept term in the forecasting model. Default is False.</span>
<span class="sd">        cv : int, optional</span>
<span class="sd">            Number of cross-validation folds for model validation. Default is 4.</span>
<span class="sd">        n_iter : int, optional</span>
<span class="sd">            Number of iterations to use during cross-validation or parameter tuning. Default is 100.</span>
<span class="sd">        original_scale : bool, optional</span>
<span class="sd">            If True, the forecasted values are converted back to their original scale. Default is True.</span>
<span class="sd">        sort_df : str, optional</span>
<span class="sd">            The method used to sort the features for the forecast model. Options include &#39;criteria&#39;. Default is &#39;criteria&#39;.</span>
<span class="sd">        sort_col : int, optional</span>
<span class="sd">            The column index to use for sorting when selecting features. Default is -1 (the last column).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">            Updates the attributes with forecast results, including various performance metrics and forecast data.</span>

<span class="sd">        Attributes Updated</span>
<span class="sd">        ------------------</span>
<span class="sd">        MAFE_val_df : pd.DataFrame</span>
<span class="sd">            Mean Absolute Forecasting Error (MAFE) values for the validation set.</span>
<span class="sd">        MAFE_val_df_improve : pd.DataFrame</span>
<span class="sd">            Improvement in MAFE values compared to a benchmark.</span>
<span class="sd">        MSFE_val_df : pd.DataFrame</span>
<span class="sd">            Mean Squared Forecasting Error (MSFE) values for the validation set.</span>
<span class="sd">        MSFE_val_df_improve : pd.DataFrame</span>
<span class="sd">            Improvement in MSFE values compared to a benchmark.</span>
<span class="sd">        forecast_criteria_df : pd.DataFrame</span>
<span class="sd">            DataFrame containing criteria values used for selecting features during forecasting.</span>
<span class="sd">        lags_df : pd.DataFrame</span>
<span class="sd">            DataFrame representing the lags used for each feature in the model.</span>
<span class="sd">        MAFE_train_df : pd.DataFrame</span>
<span class="sd">            MAFE values for the training set.</span>
<span class="sd">        MSFE_train_df : pd.DataFrame</span>
<span class="sd">            MSFE values for the training set.</span>
<span class="sd">        forecast_dict : dict</span>
<span class="sd">            Dictionary containing forecasted values for different horizons.</span>
<span class="sd">        hsi : pd.DataFrame</span>
<span class="sd">            DataFrame containing the forecasted HPI values.</span>
<span class="sd">        results_table : pd.DataFrame</span>
<span class="sd">            Table summarizing the forecast results, including performance metrics.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        - This method forecasts the HPI using a combination of Google Trends data and selected lagged features.</span>
<span class="sd">        - Various forecast horizons can be specified using the `h_list` parameter to produce forecasts for different time periods.</span>
<span class="sd">        - The method can optionally fit an intercept term and use cross-validation to select the most important features.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">h_list</span> <span class="o">=</span> <span class="n">h_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">original_scale</span> <span class="o">=</span> <span class="n">original_scale</span>
        
        <span class="n">MAFE_val_df</span><span class="p">,</span> <span class="n">MAFE_val_df_improve</span><span class="p">,</span> <span class="n">MSFE_val_df</span><span class="p">,</span> <span class="n">MSFE_val_df_improve</span><span class="p">,</span> <span class="n">forecast_criteria_df</span><span class="p">,</span> <span class="n">lags_df</span><span class="p">,</span> <span class="n">MAFE_train_df</span><span class="p">,</span> <span class="n">MSFE_train_df</span><span class="p">,</span> <span class="n">forecast_dict</span><span class="p">,</span> <span class="n">df</span> <span class="o">=</span> <span class="n">compare_exog</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">forecast_hsi</span><span class="p">,</span> <span class="n">train_cut</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">train_cut</span><span class="p">,</span> <span class="n">h_list</span><span class="o">=</span><span class="n">h_list</span><span class="p">,</span> <span class="n">seasonal</span><span class="o">=</span><span class="n">seasonal</span><span class="p">,</span> <span class="n">max_lag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_lag</span><span class="p">,</span> <span class="n">lag_select</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lag_select</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">,</span> <span class="n">lag_fit_intercept</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lag_fit_intercept</span><span class="p">,</span> <span class="n">lag_cv</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lag_cv</span><span class="p">,</span> <span class="n">lag_shuffle</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span><span class="p">,</span> <span class="n">lag_iter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lag_iter</span><span class="p">,</span> <span class="n">hsi_CV_select</span><span class="o">=</span><span class="n">hsi_CV_select</span><span class="p">,</span> <span class="n">hsi_fit_intercept</span><span class="o">=</span><span class="n">fit_intercept</span><span class="p">,</span> <span class="n">hsi_cv</span><span class="o">=</span><span class="n">cv</span><span class="p">,</span> <span class="n">hsi_iter</span><span class="o">=</span><span class="n">n_iter</span><span class="p">,</span> <span class="n">y_lags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">y_lags</span><span class="p">,</span> <span class="n">exog_lags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">exog_lags</span><span class="p">,</span> <span class="n">var_order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">var_order</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">,</span> <span class="n">original_hpi</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">original_hpi</span><span class="p">,</span> <span class="n">original_scale</span><span class="o">=</span><span class="n">original_scale</span><span class="p">,</span> <span class="n">sort_df</span><span class="o">=</span><span class="n">sort_df</span><span class="p">,</span>  <span class="n">sort_col</span><span class="o">=</span><span class="n">sort_col</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">MAFE_val_df</span> <span class="o">=</span> <span class="n">MAFE_val_df</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">MAFE_val_df_improve</span> <span class="o">=</span> <span class="n">MAFE_val_df_improve</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">MSFE_val_df</span> <span class="o">=</span> <span class="n">MSFE_val_df</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">MSFE_val_df_improve</span> <span class="o">=</span> <span class="n">MSFE_val_df_improve</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forecast_criteria_df</span> <span class="o">=</span> <span class="n">forecast_criteria_df</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lags_df</span> <span class="o">=</span> <span class="n">lags_df</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">MAFE_train_df</span> <span class="o">=</span> <span class="n">MAFE_train_df</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">MSFE_train_df</span> <span class="o">=</span> <span class="n">MSFE_train_df</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forecast_dict</span> <span class="o">=</span> <span class="n">forecast_dict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hsi</span> <span class="o">=</span> <span class="n">df</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results_table</span> <span class="o">=</span> <span class="n">forecast_table</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

        <span class="c1"># self.hsi_dfs[-1] = df</span>
        
<div class="viewcode-block" id="GoogleTrend.results">
<a class="viewcode-back" href="../google_trends_functions.html#google_trends_functions.GoogleTrend.results">[docs]</a>
    <span class="k">def</span> <span class="nf">results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results_table</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">MAFE_val_df</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">MAFE_val_df_improve</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">MSFE_val_df</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">MSFE_val_df_improve</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">forecast_criteria_df</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">lags_df</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">MAFE_train_df</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">head</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Displays various results from the model, including performance metrics and forecast data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        results_table : bool, optional</span>
<span class="sd">            If True, displays the full results table summarizing the forecast performance. Default is False.</span>
<span class="sd">        MAFE_val_df : bool, optional</span>
<span class="sd">            If True, displays the Mean Absolute Forecasting Error (MAFE) values for the validation set. Default is False.</span>
<span class="sd">        MAFE_val_df_improve : bool, optional</span>
<span class="sd">            If True, displays the improvement in MAFE values compared to a benchmark. Default is False.</span>
<span class="sd">        MSFE_val_df : bool, optional</span>
<span class="sd">            If True, displays the Mean Squared Forecasting Error (MSFE) values for the validation set. Default is False.</span>
<span class="sd">        MSFE_val_df_improve : bool, optional</span>
<span class="sd">            If True, displays the improvement in MSFE values compared to a benchmark. Default is False.</span>
<span class="sd">        forecast_criteria_df : bool, optional</span>
<span class="sd">            If True, displays the DataFrame containing criteria values used for selecting features during forecasting. Default is False.</span>
<span class="sd">        lags_df : bool, optional</span>
<span class="sd">            If True, displays the DataFrame representing the lags used for each feature in the model. Default is False.</span>
<span class="sd">        MAFE_train_df : bool, optional</span>
<span class="sd">            If True, displays the MAFE values for the training set. Default is False.</span>
<span class="sd">        head : int, optional</span>
<span class="sd">            Number of rows to display when displaying the results DataFrames. Default is 10.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">            Displays the specified results based on the provided parameters.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        - This method allows the user to access different performance metrics and forecast-related data.</span>
<span class="sd">        - By selecting the appropriate parameters, users can view specific tables and metrics that summarize the model&#39;s forecasting performance.</span>
<span class="sd">        - The `head` parameter controls the number of rows to display for DataFrames to avoid overwhelming output.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results_table</span><span class="o">=</span><span class="n">results_table</span><span class="p">,</span> <span class="n">MAFE_val_df</span><span class="o">=</span><span class="n">MAFE_val_df</span><span class="p">,</span> <span class="n">MAFE_val_df_improve</span><span class="o">=</span><span class="n">MAFE_val_df_improve</span><span class="p">,</span> <span class="n">MSFE_val_df</span><span class="o">=</span><span class="n">MSFE_val_df</span><span class="p">,</span> <span class="n">MSFE_val_df_improve</span><span class="o">=</span><span class="n">MSFE_val_df_improve</span><span class="p">,</span> <span class="n">forecast_criteria_df</span><span class="o">=</span><span class="n">forecast_criteria_df</span><span class="p">,</span> <span class="n">lags_df</span><span class="o">=</span><span class="n">lags_df</span><span class="p">,</span> <span class="n">MAFE_train_df</span><span class="o">=</span><span class="n">MAFE_train_df</span><span class="p">,</span> <span class="n">head</span><span class="o">=</span><span class="n">head</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="GoogleTrend.plot_gtrends">
<a class="viewcode-back" href="../google_trends_functions.html#google_trends_functions.GoogleTrend.plot_gtrends">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_gtrends</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exog</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">winsorize_trend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">scaled</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        exog : list of str or None, optional</span>
<span class="sd">            List of exogenous variables (Google Trends features) to plot. If None, all available features are plotted. Default is None.</span>
<span class="sd">        h : int, optional</span>
<span class="sd">            The forecast horizon for which the trends are plotted. Default is 12.</span>
<span class="sd">        winsorize_trend : bool, optional</span>
<span class="sd">            If True, plots the Google Trends data after winsorization, which reduces the effect of outliers. Default is False.</span>
<span class="sd">        scaled : bool, optional</span>
<span class="sd">            If True, plots the scaled version of Google Trends data, allowing for comparison across different features. Default is False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">            Displays the plots for the specified Google Trends features.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        - This method provides a visual representation of Google Trends data used in the model, which helps in understanding the temporal patterns in the data.</span>
<span class="sd">        - Users can optionally plot specific features by providing a list in the `exog` parameter.</span>
<span class="sd">        - The `winsorize_trend` parameter allows for a clearer view by minimizing the impact of extreme values.</span>
<span class="sd">        - The `scaled` parameter enables visualization of standardized features, useful for comparing different variables on the same scale.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">plot_gtrends</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exog</span><span class="o">=</span><span class="n">exog</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="n">h</span><span class="p">,</span> <span class="n">winsorize_trend</span><span class="o">=</span><span class="n">winsorize_trend</span><span class="p">,</span> <span class="n">scaled</span><span class="o">=</span><span class="n">scaled</span><span class="p">)</span></div>

        
<div class="viewcode-block" id="GoogleTrend.plot_hsi">
<a class="viewcode-back" href="../google_trends_functions.html#google_trends_functions.GoogleTrend.plot_hsi">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_hsi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hsi</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plots the Housing Sentiment Index (HSI) data used in the model, allowing for visualization of the extracted features.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        hsi : list of str or None, optional</span>
<span class="sd">            List of HSI features to plot. If None, all available HSI features are plotted. Default is None.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">            Displays the plots for the specified HSI features.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        - This method provides a visual representation of the HSI features that have been extracted using PCA and other transformations.</span>
<span class="sd">        - The `hsi` parameter allows users to specify particular HSI features to visualize, or plot all available features if set to None.</span>
<span class="sd">        - Useful for analyzing the derived sentiment features and understanding their temporal patterns.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">plot_hsi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hsi</span><span class="o">=</span><span class="n">hsi</span><span class="p">)</span></div>

        
<div class="viewcode-block" id="GoogleTrend.plot_improvement">
<a class="viewcode-back" href="../google_trends_functions.html#google_trends_functions.GoogleTrend.plot_improvement">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_improvement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">measure</span><span class="o">=</span><span class="s1">&#39;MAFE&#39;</span><span class="p">,</span> <span class="n">h_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">9</span><span class="p">)):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Plots the improvement in forecasting accuracy for different horizons, using a specified performance measure.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        measure : str, optional</span>
<span class="sd">            The performance measure to visualize. Options include &#39;MAFE&#39; (Mean Absolute Forecasting Error) and &#39;MSFE&#39; (Mean Squared Forecasting Error). Default is &#39;MAFE&#39;.</span>
<span class="sd">        h_list : list of int or None, optional</span>
<span class="sd">            A list of forecast horizons to include in the plot. If None, all available horizons are included. Default is None.</span>
<span class="sd">        colors : list of str or None, optional</span>
<span class="sd">            List of colors to use for the plot lines. If None, default colors are used. Default is None.</span>
<span class="sd">        labels : list of str or None, optional</span>
<span class="sd">            List of labels for each forecast horizon in the plot. If None, default labels are used. Default is None.</span>
<span class="sd">        figsize : tuple of int, optional</span>
<span class="sd">            Figure size for the plot. Default is (15, 9).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">            Displays a plot showing the improvement in forecasting accuracy for the specified measure and horizons.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        - This method helps visualize the improvement in forecasting performance for different horizons.</span>
<span class="sd">        - The `measure` parameter allows the user to specify whether to visualize Mean Absolute Forecasting Error (MAFE) or Mean Squared Forecasting Error (MSFE).</span>
<span class="sd">        - Users can customize the appearance of the plot using the `colors`, `labels`, and `figsize` parameters.</span>
<span class="sd">        - The `h_list` parameter allows for selecting specific forecast horizons to analyze, which can be useful for evaluating the model&#39;s performance over varying time periods.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">plot_improvement</span><span class="p">([</span><span class="bp">self</span><span class="p">],</span> <span class="n">measure</span><span class="o">=</span><span class="n">measure</span><span class="p">,</span> <span class="n">h_list</span><span class="o">=</span><span class="n">h_list</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span></div>

        
<div class="viewcode-block" id="GoogleTrend.plot_forecast">
<a class="viewcode-back" href="../google_trends_functions.html#google_trends_functions.GoogleTrend.plot_forecast">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_forecast</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exog</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plots the forecasted Housing Price Index (HPI) values along with the actual values for comparison.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        exog : list of str or None, optional</span>
<span class="sd">            List of exogenous variables (features) to include in the forecast plot. If None, all available features are included. Default is None.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">            Displays the forecast plot showing the predicted HPI values and the actual values.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        - This method provides a visual comparison between the forecasted HPI values and the actual values, allowing users to assess the model&#39;s predictive performance.</span>
<span class="sd">        - The `exog` parameter allows users to include specific exogenous features in the plot for further analysis of their impact on the forecast.</span>
<span class="sd">        - Useful for evaluating the quality of the model&#39;s predictions over different time horizons.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">plot_forecast</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exog</span><span class="o">=</span><span class="n">exog</span><span class="p">)</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Mohammad Ebrahimi.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>